import{r as o,j as r,a as Ce}from"./app-BLq9qGjh.js";import{d as Se}from"./index-C2jAZdz9.js";import Re from"./CatchGame-BFotgK_T.js";import be from"./PlanePathGame-DtBliZU8.js";import{T as ke}from"./TestResultDialog-Ct2g_fkg.js";import{C as Te}from"./Card-C1GU02v-.js";import{C as _e}from"./CardContent-DCgqHPo6.js";import{T as k,r as V}from"./Modal-De_ycrcN.js";import{L as Me}from"./LinearProgress-DeS7CSV4.js";import{B as $}from"./Box-Cz7V3xGm.js";import{S as z,F as q}from"./Stack-D08xgxbL.js";import{B as F}from"./Button-CuNxhS1F.js";import{D as Ae}from"./Dialog-D-u6Do8Y.js";import{D as Be,a as Pe,b as De}from"./DialogTitle-BsS6_qF-.js";import{R as $e,a as ee}from"./RadioGroup-D6pcOw8C.js";import"./index-B1RQIcyM.js";import"./getThemeProps-Deont-l5.js";import"./index-C-LZr9ID.js";import"./useFormControl-DrCdXN2E.js";import"./useThemeProps-CxXTaoeJ.js";import"./createSvgIcon-C0m7Iky1.js";import"./FormGroup-CZXF_j8I.js";function nt({test:c,subject:d}){var Y,Z;const f=(c==null?void 0:c.test_questions)||[],C=o.useMemo(()=>f.filter(e=>e.type==="math"),[f]),S=o.useMemo(()=>f.filter(e=>e.type==="figure"),[f]),i=o.useMemo(()=>{const e=[],t=Math.min(C.length,S.length);for(let n=0;n<t;n++)e.push([C[n],S[n]]);return e},[C,S]),R=o.useRef({});o.useEffect(()=>{const e={};for(const t of f)e[t.id]=(t==null?void 0:t.is_correct)!==null||(t==null?void 0:t.user_answer)!==null&&(t==null?void 0:t.user_answer)!=="";R.current=e},[f]);const[g,T]=o.useState(0),[te,re]=o.useState({}),[G,ne]=o.useState({}),[x,oe]=o.useState({}),[I,se]=o.useState({}),[j,_]=o.useState(null),[M,W]=o.useState(null),[ie,E]=o.useState(!0),L=e=>`mtk:gameType:${e}`,[ae,H]=o.useState(0),[ce,O]=o.useState(!1),[Q,le]=o.useState({correct:0,total:100}),U=e=>(e==null?void 0:e.is_correct)!==null||(e==null?void 0:e.user_answer)!==null&&(e==null?void 0:e.user_answer)!=="",N=e=>U(e)||!!x[e==null?void 0:e.id],A=(e,t)=>{const[n,s]=i[e]||[],a=l=>!l||U(l)||!!t[l.id];return a(n)&&a(s)},J=e=>{if(!i.length)return!1;for(let t=0;t<i.length;t++)if(!A(t,e))return!1;return!0};function de(e){for(let t=0;t<e.length;t++){const[n,s]=e[t],a=R.current[n.id]||x[n.id],l=R.current[s.id]||x[s.id];if(!a||!l)return t}return e.length?0:null}function B(e){return A(e,x)}function ue(){for(let e=g+1;e<i.length;e++)if(!B(e)){T(e);return}for(let e=0;e<i.length;e++)if(!B(e)){T(e);return}D()}o.useEffect(()=>{const e=de(i);e!==null&&T(e)},[i.length]),o.useEffect(()=>{if(!(c!=null&&c.id))return;const e=localStorage.getItem(L(c.id));_(e==="vertical"||e==="horizontal"?e:null),E(!0),W(null)},[c==null?void 0:c.id]);const he=()=>{j&&(localStorage.setItem(L(c.id),j),W(j),E(!1))},P=o.useRef(new Set),fe=e=>{var a;const t=`${e.test_id}:${(a=e.current_question)==null?void 0:a.id}`;if(P.current.has(t))return Promise.resolve();P.current.add(t);const n=new AbortController,s=setTimeout(()=>n.abort("timeout"),4e3);return Ce.post(route("answer.save"),e,{signal:n.signal,headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json"}}).catch(l=>{console.error("❌ Error al enviar respuesta",l),P.current.delete(t)}).finally(()=>clearTimeout(s))},b=o.useRef(!1),X=(e,t)=>{if(!e||N(e))return;const n=String(t).toUpperCase()===String(e.correct_answer).toUpperCase();re(s=>({...s,[e.id]:t})),ne(s=>({...s,[e.id]:n?"correct":"incorrect"})),oe(s=>{const a={...s,[e.id]:!0};se(p=>({...p,[e.id]:n?1:0}));const l={test_id:c==null?void 0:c.id,subject_id:(d==null?void 0:d.id)??null,current_question:e,is_correct:n?1:0,user_answer:String(t)};return fe(l).then(()=>{R.current[e.id]=!0}),A(g,a)&&(J(a)?b.current||(b.current=!0,D()):ue()),a})};o.useEffect(()=>{!b.current&&J(x)&&(b.current=!0,D())},[x,i]);const xe=o.useMemo(()=>{let e=0;for(let t=0;t<i.length;t++)B(t)&&(e+=1);return e},[g,x,f]),pe=i.length?xe/i.length*100:0;function D(){const e=i.length||1,t=C.reduce((p,m)=>{const y=m.is_correct===1||I[m.id]===1?1:0;return p+y},0),n=S.reduce((p,m)=>{const y=m.is_correct===1||I[m.id]===1?1:0;return p+y},0),s=Math.round(t/e*100),a=Math.round(n/e*100),l=Math.round(.4*(ae||0)+.3*s+.3*a);le({correct:l,total:100}),O(!0)}const w=(Y=i[g])==null?void 0:Y[0],v=(Z=i[g])==null?void 0:Z[1],me=e=>G[e]==="correct",ge=e=>G[e]==="incorrect",K=(e,t)=>{const n=te[e.id],s={minWidth:120,backgroundColor:"#e0e0e0",color:"#000",border:"2px solid transparent"};if(N(e))return{...s,opacity:.7,pointerEvents:"none"};if(n===t){if(me(e.id))return{...s,backgroundColor:"#dcfce7",border:"2px solid #16a34a"};if(ge(e.id))return{...s,backgroundColor:"#fee2e2",border:"2px solid #dc2626"}}return s},je=({text:e,color:t="#203764",size:n=56})=>{const s=String(e||"").split(/(\|)/).map(u=>u.trim()).filter(Boolean),a=()=>r.jsx("svg",{width:Math.max(10,n*.18),height:n,viewBox:"0 0 12 100",children:r.jsx("rect",{x:"4",y:"10",width:"4",height:"80",rx:"2",fill:t})}),l=()=>r.jsx("svg",{width:n,height:n,viewBox:"0 0 100 100",children:r.jsx("circle",{cx:"50",cy:"50",r:"36",fill:t})}),p=()=>r.jsx("svg",{width:n,height:n,viewBox:"0 0 100 100",children:r.jsx("rect",{x:"15",y:"15",width:"70",height:"70",rx:"6",fill:t})}),m=()=>r.jsx("svg",{width:n,height:n,viewBox:"0 0 100 100",children:r.jsx("polygon",{points:"50,12 90,88 10,88",fill:t})}),y=()=>r.jsx("svg",{width:n,height:n,viewBox:"0 0 100 100",children:r.jsx("polygon",{points:"50,10 90,50 50,90 10,50",fill:t})}),we=()=>r.jsx("svg",{width:n,height:n,viewBox:"0 0 100 100",children:r.jsx("polygon",{points:"50,8 61,37 92,37 66,55 75,86 50,69 25,86 34,55 8,37 39,37",fill:t})}),ve=({outline:u=!0})=>r.jsx("svg",{width:n,height:n,viewBox:"0 0 100 100",children:r.jsx("polygon",{points:"50,10 84,30 84,70 50,90 16,70 16,30",fill:u?"none":t,stroke:u?t:"none",strokeWidth:u?8:0,strokeLinejoin:"round"})}),ye=(u,h)=>{switch(u){case"|":return r.jsx(a,{},`bar-${h}`);case"▲":return r.jsx(m,{},`tri-${h}`);case"■":return r.jsx(p,{},`sq-${h}`);case"◆":return r.jsx(y,{},`dm-${h}`);case"★":return r.jsx(we,{},`st-${h}`);case"⬡":return r.jsx(ve,{outline:!0},`hx-${h}`);case"●":case"⬤":return r.jsx(l,{},`ci-${h}`);default:return r.jsx($,{sx:{fontSize:`${n*.6}px`,color:t,lineHeight:1},children:u},`tx-${h}`)}};return r.jsx($,{sx:{display:"flex",alignItems:"center",justifyContent:"center",gap:2,flexWrap:"wrap",my:1},children:s.map(ye)})};return r.jsxs(r.Fragment,{children:[r.jsx(Te,{sx:{mb:4,borderRadius:3,boxShadow:3},children:r.jsxs(_e,{sx:{backgroundColor:`${(d==null?void 0:d.color)??"#1976d2"}80`,borderTopLeftRadius:"12px",borderTopRightRadius:"12px"},children:[r.jsx(k,{variant:"h6",children:(d==null?void 0:d.name)??"Multitasking"}),r.jsx(Me,{variant:"determinate",value:pe})]})}),r.jsxs($,{display:"flex",justifyContent:"center",alignItems:"stretch",gap:2,flexWrap:"wrap",px:2,minHeight:"60vh",children:[r.jsxs(V,{sx:{p:3,width:500,borderRadius:3,backgroundColor:"#fff",display:"flex",flexDirection:"column",alignItems:"center",minHeight:420},children:[M==="vertical"&&r.jsx(Re,{onFinish:e=>H(e??0)}),M==="horizontal"&&r.jsx(be,{onFinish:e=>H(e??0)}),!M&&r.jsxs(k,{variant:"body2",color:"text.secondary",sx:{mt:2},children:["Selecciona un juego y presiona ",r.jsx("strong",{children:"Comenzar"}),"."]})]}),r.jsxs(V,{sx:{p:3,width:500,borderRadius:3,backgroundColor:"#fff",display:"flex",flexDirection:"column",alignItems:"center"},children:[w&&r.jsxs(r.Fragment,{children:[r.jsx(k,{variant:"h3",mb:2,textAlign:"center",sx:{mt:2},children:w.question_text}),r.jsx(z,{direction:"row",spacing:2,mb:5,flexWrap:"wrap",justifyContent:"center",children:Object.entries(JSON.parse(w.options||"{}")).filter(([e,t])=>t!=null&&t!=="").slice(0,2).map(([e,t])=>r.jsx(F,{variant:"contained",sx:K(w,t),onClick:()=>X(w,t),children:t},e))})]}),v&&r.jsxs(r.Fragment,{children:[r.jsx(je,{text:v.question_text,color:"#203764"}),r.jsx(z,{direction:"row",spacing:2,mb:2,flexWrap:"wrap",justifyContent:"center",children:Object.entries(JSON.parse(v.options||"{}")).filter(([e,t])=>t!=null&&t!=="").map(([e,t])=>r.jsx(F,{variant:"contained",sx:K(v,t),onClick:()=>X(v,t),children:t},e))})]}),r.jsxs(k,{variant:"body2",color:"text.secondary",sx:{mt:1},children:["Bloque ",g+1," de ",i.length]})]})]}),r.jsxs(Ae,{open:ie,children:[r.jsx(Be,{children:"¿Qué tipo de juego prefieres?"}),r.jsx(Pe,{children:r.jsxs($e,{value:j,onChange:e=>_(e.target.value),children:[r.jsx(q,{value:"vertical",control:r.jsx(ee,{}),label:"Vertical (Balde)"}),r.jsx(q,{value:"horizontal",control:r.jsx(ee,{}),label:"Horizontal (Avión)"})]})}),r.jsx(De,{children:r.jsx(F,{onClick:he,disabled:!j,variant:"contained",children:"Comenzar"})})]}),r.jsx(ke,{open:ce,onClose:()=>O(!1),correct:Q.correct,total:Q.total,onGoToSubjects:()=>Se.Inertia.get(route("student.subject.index")),showReview:!1})]})}export{nt as default};
