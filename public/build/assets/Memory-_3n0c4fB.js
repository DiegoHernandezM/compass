import{r,j as o,a as z}from"./app-BLq9qGjh.js";import{d as H}from"./index-C2jAZdz9.js";import{I as C}from"./index-CRfPOSmF.js";import{T as J}from"./TestResultDialog-Ct2g_fkg.js";import{B as x}from"./Box-Cz7V3xGm.js";import{T as M}from"./Modal-De_ycrcN.js";import{G as A}from"./Grid-DtBzsujO.js";import{B as X}from"./Button-CuNxhS1F.js";import"./createSvgIcon-C0m7Iky1.js";import"./School-DyR7C2LF.js";import"./Close-C3PnWu73.js";import"./Person-CORynGXJ.js";import"./Edit-yhFPSgDj.js";import"./MenuBook-vcyJ5ap0.js";import"./Logout-CUDp4jRG.js";import"./VisibilityOff-B8scy8B3.js";import"./index-B1RQIcyM.js";import"./getThemeProps-Deont-l5.js";import"./Dialog-D-u6Do8Y.js";import"./DialogTitle-BsS6_qF-.js";import"./useThemeProps-CxXTaoeJ.js";import"./isMuiElement-CGz5YhyF.js";function ge({subject:f,test:c}){const[i,g]=r.useState(()=>(c.test_questions||[]).map(e=>({...e}))),I=i.findIndex(e=>e.is_correct===null),[m,D]=r.useState(I===-1?0:I),[l,S]=r.useState("show"),[y,_]=r.useState(null),[h,R]=r.useState([]),[F,k]=r.useState(!1),[O,j]=r.useState(!1),[v,b]=r.useState({correct:0,total:i.length}),w=r.useRef(new Set),p=i[m],[q,T]=r.useState({}),a=r.useMemo(()=>p.question_text.split(",").map(e=>e.trim()),[p]);r.useEffect(()=>{const e={};for(const t of c.test_questions)(t.is_correct===0||t.is_correct===1)&&(e[t.id]=t.is_correct);T(e)},[c==null?void 0:c.id]),r.useEffect(()=>{I===-1&&(k(!0),b(W()),j(!0))},[]),r.useEffect(()=>{b(E(q))},[m,q]);const E=e=>{const t=c.test_questions.length;let s=0;for(const n of c.test_questions)e[n.id]===0||e[n.id]===1?s+=e[n.id]:n.is_correct===1&&(s+=1);return{correct:s,total:t}},G=r.useMemo(()=>{const e=K(a,8-a.length);return B([...a,...e])},[m]);r.useEffect(()=>{if(l==="show"){let e=0;const t=setInterval(()=>{e<a.length?(_(a[e]),e++):(clearInterval(t),_(null),setTimeout(()=>S("select"),500))},1e3);return()=>clearInterval(t)}},[l,m,a]);const L=e=>{l==="select"&&R(t=>t.includes(e)?t.filter(s=>s!==e):[...t,e])},P=()=>{if(!p)return;S("feedback");const e=[...h].sort(),t=[...a].sort(),s=JSON.stringify(e)===JSON.stringify(t);T(u=>{const d={...u,[p.id]:s?1:0};return b(E(d)),d}),g(u=>u.map(d=>d.id===p.id?{...d,is_correct:s?1:0,user_answer:h.join(",")}:d));const n={test_id:c.id,subject_id:(f==null?void 0:f.id)??null,current_question:p,is_correct:s?1:0,user_answer:h.join(",")};Q(n),setTimeout(()=>{m+1<i.length?(D(m+1),S("show"),R([])):(k(!0),j(!0))},3e3)},Q=e=>{var u;const t=`${e.test_id}:${(u=e.current_question)==null?void 0:u.id}`;if(w.current.has(t))return Promise.resolve();w.current.add(t);const s=new AbortController,n=setTimeout(()=>s.abort("timeout"),4e3);return z.post(route("answer.save"),e,{signal:s.signal,headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json"}}).catch(d=>{console.error("❌ Error al enviar respuesta",d),w.current.delete(t)}).finally(()=>{clearTimeout(n)})},W=()=>{const e=i.length;return{correct:i.reduce((s,n)=>s+(n.is_correct?1:0),0),total:e}},$=e=>{const t=C[e],s=h.includes(e),n=a.includes(e),u=l==="feedback"?s?n?"green":"red":n?"green":"gray":s?"blue":"gray";return o.jsx(A,{item:!0,xs:6,sm:4,md:3,lg:3,children:o.jsx(x,{onClick:()=>L(e),sx:{backgroundColor:"rgba(32, 55, 100, 0.85)",border:`5px solid ${u}`,borderRadius:2,p:2,cursor:l==="select"?"pointer":"default",width:"100%",height:200,boxShadow:2,display:"flex",alignItems:"center",justifyContent:"center",maxWidth:200,mx:"auto",transition:"transform 0.2s ease, box-shadow 0.2s ease","&:hover":{transform:"scale(1.05)",boxShadow:"0 0 15px rgba(236, 211, 88, 0.6)"}},children:t?o.jsx(t,{sx:{fontSize:90,color:"white"}}):e})},e)};return F?o.jsx(J,{open:O,onClose:()=>j(!1),correct:v.correct,total:v.total,onGoToSubjects:()=>H.Inertia.get(route("student.subject.index")),showReview:!1}):o.jsxs(x,{minHeight:"100vh",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",px:2,textAlign:"center",children:[o.jsxs(M,{variant:"h5",children:["Pregunta ",m+1," de ",i.length]}),l==="show"&&y&&o.jsx(x,{mt:5,display:"flex",justifyContent:"center",alignItems:"center",height:"300px",children:o.jsx(x,{sx:{backgroundColor:"rgba(32, 55, 100, 0.85)",border:"3px solid #ECD358",borderRadius:2,width:200,height:200,boxShadow:"0 0 10px rgba(236, 211, 88, 0.5)",display:"flex",alignItems:"center",justifyContent:"center"},children:(()=>{const e=C[y];return e?o.jsx(e,{sx:{fontSize:90,color:"white"}}):null})()})}),(l==="select"||l==="feedback")&&o.jsxs(o.Fragment,{children:[o.jsx(M,{mt:3,children:"Selecciona los iconos que recuerdas"}),o.jsx(A,{container:!0,spacing:3,justifyContent:"center",alignItems:"center",mt:2,maxWidth:"lg",children:G.map($)}),l==="select"&&o.jsx(X,{variant:"contained",onClick:P,sx:{mt:3},children:"Confirmar selección"})]})]})}function K(f=[],c=5){const i=Object.keys(C).filter(g=>!f.includes(g));return B(i).slice(0,c)}function B(f){return[...f].sort(()=>Math.random()-.5)}export{ge as default};
