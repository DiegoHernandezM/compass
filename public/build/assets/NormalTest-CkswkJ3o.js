import{r as a,j as o,a as be}from"./app-BEt_j3y4.js";import{d as we}from"./index-CFfXh916.js";import{D as je}from"./Dialog-CJdmGbGA.js";import{D as Se,a as Ee,b as Fe}from"./DialogTitle-CjaMSVqh.js";import{a as De,g as Re,b as Ae,s as ke,k as ve,d as ye,T as _,v as Te,u as Be,r as Ie,ag as Le}from"./Modal-lD_zqTbe.js";import{B as E}from"./Button-CzMRS666.js";import{S as Ne,u as Z}from"./index-DazhPLGl.js";import{T as Ke}from"./TestResultDialog-Kt5kzWWM.js";import{C as Pe}from"./Card-DD9UwPwp.js";import{C as Ue}from"./CardContent-DCnC0e5G.js";import{L as Q}from"./LinearProgress-bb-S99J7.js";import{B as S}from"./Box-Dr-7W-DA.js";import{R as Me,a as $e}from"./RadioGroup-CQRMXbA_.js";import{F as qe,S as Oe}from"./Stack-BqKEWwW1.js";import"./getThemeProps-BKhbLW6y.js";import"./index-Do89Vuqu.js";import"./createSvgIcon-DGl_gyGm.js";import"./useFormControl-9_bnhKvp.js";import"./FormGroup-B5EkKCuE.js";import"./useThemeProps-T18jd7Co.js";function We(t){return De("MuiDialogContentText",t)}Re("MuiDialogContentText",["root"]);const Ge=t=>{const{classes:c}=t,u=ye({root:["root"]},We,c);return{...c,...u}},He=ke(_,{shouldForwardProp:t=>Te(t)||t==="classes",name:"MuiDialogContentText",slot:"Root"})({}),Xe=a.forwardRef(function(c,g){const u=Ae({props:c,name:"MuiDialogContentText"}),{children:h,className:F,...i}=u,f=Ge(i);return o.jsx(He,{component:"p",variant:"body1",color:"textSecondary",ref:g,ownerState:i,className:ve(f.root,F),...u,classes:f})}),ze=a.forwardRef(function(c,g){return o.jsx(Ne,{direction:"up",ref:g,...c})});function Je({open:t,close:c,message:g,image:u}){return o.jsx(a.Fragment,{children:o.jsxs(je,{open:t,slots:{transition:ze},keepMounted:!0,onClose:c,"aria-describedby":"alert-dialog-slide-description",PaperProps:{sx:{borderRadius:4}},children:[o.jsx(Se,{children:"Explicación"}),o.jsx(Ee,{children:o.jsxs(Xe,{id:"alert-dialog-slide-description",children:[g,u&&o.jsx("div",{style:{display:"flex",justifyContent:"center",margin:"20px 0"},children:o.jsx("img",{src:u,alt:"feedback image",style:{height:300,width:"auto"}})})]})}),o.jsx(Fe,{children:o.jsx(E,{onClick:c,children:"Cerrar"})})]})})}function ht({test:t,subject:c,type:g}){var V,Y;const u=Be(),h=Z(u.breakpoints.up("md")),F=Z(u.breakpoints.down("sm")),[i,f]=a.useState(0),[b,D]=a.useState({}),s=(V=t==null?void 0:t.test_questions)==null?void 0:V[i],[C,R]=a.useState(null),[N,ee]=a.useState(null),[te,A]=a.useState(!1),[l,k]=a.useState("ANSWERING"),[v,K]=a.useState(null),se=1500,re=2500,[y,P]=a.useState(!1),[Ve,U]=a.useState(!1),[oe,T]=a.useState(null),[M,$]=a.useState(null),B=a.useRef(new Set),q=a.useRef(new Set),[ne,I]=a.useState(!1),[O,W]=a.useState({correct:0,total:0}),ae=String((s==null?void 0:s.correct_answer)||"").toUpperCase(),[G,H]=a.useState(!1),w=e=>(e==null?void 0:e.is_correct)!==null||!!(e!=null&&e.user_answer),ie=e=>{const r={};return e.forEach(n=>{n.user_answer&&(r[n.id]=String(n.user_answer).toLowerCase())}),r},ce=e=>{const r=e.findIndex(n=>!w(n));return r===-1?0:r},X=(e,r)=>{for(let n=r+1;n<e.length;n++)if(!w(e[n]))return n;return null},m=s?w(s)||q.current.has(s.id):!1,z=l==="FEEDBACK";a.useEffect(()=>{var e;(e=t==null?void 0:t.test_questions)!=null&&e.length&&(D(ie(t.test_questions)),f(ce(t.test_questions)),k("ANSWERING"),R(null),A(!1),K(null))},[t==null?void 0:t.id]),a.useEffect(()=>{["/assets/correct.gif","/assets/incorrect.gif"].forEach(e=>{const r=new Image;r.src=e})},[]),a.useEffect(()=>{if(!s)return;if(w(s)){T(null),$(null);return}const e=(s==null?void 0:s.limit_time)??null;if(T(e),$(e),!e||z)return;const r=setInterval(()=>{T(n=>n===null?n:n<=1?(clearInterval(r),L(null,!0),0):n-1)},1e3);return()=>clearInterval(r)},[s,z]),a.useEffect(()=>{if(l!=="FEEDBACK"||!v||y)return;const e=Math.max(0,v-Date.now()),r=setTimeout(()=>{if(A(!1),k("ANSWERING"),R(null),G){H(!1);const p=J();W(p),I(!0);return}const n=X(t.test_questions,i);n!==null?f(n):i<t.test_questions.length-1&&f(i+1)},e);return()=>clearTimeout(r)},[l,v,y,i,G,t==null?void 0:t.test_questions]);const le=e=>{m||l==="FEEDBACK"||D(r=>({...r,[s.id]:e.target.value.toLowerCase()}))},L=(e="",r=!1)=>{if(m)return;const n=(e||"").toLowerCase(),p=n.toUpperCase(),d=!r&&p===s.correct_answer;q.current.add(s.id),D(j=>({...j,[s.id]:r?"__timeout__":n})),R(r?"timeout":d?"correct":"incorrect"),d||ee(s.correct_answer),!d&&!r&&(s.feedback_text||s.feedback_image)&&(P(!0),U(!0)),A(!0),k("FEEDBACK");const x=d?se:re;K(Date.now()+x),de({test_id:t==null?void 0:t.id,subject_id:(c==null?void 0:c.id)??null,current_question:s,is_correct:r?0:d?1:0,user_answer:r?null:p})},de=async e=>{var d;const r=`${e.test_id}:${(d=e.current_question)==null?void 0:d.question_id}`;if(B.current.has(r))return;B.current.add(r);const n=new AbortController,p=setTimeout(()=>n.abort("timeout"),4e3);try{await be.post(route("answer.save"),e,{signal:n.signal,headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json"}})}catch(x){x.message==="timeout"||x.code==="ERR_CANCELED"?console.warn("⏳ La petición se canceló por timeout (4s)."):console.error("❌ Error al enviar respuesta",x),B.current.delete(r)}finally{clearTimeout(p)}},ue=()=>{if(l==="FEEDBACK")return;if(m){const r=X(t.test_questions,i);r!==null?f(r):i<t.test_questions.length-1&&f(i+1);return}const e=b[s.id];e&&e!=="__timeout__"&&L(e)},fe=()=>{l!=="FEEDBACK"&&i>0&&f(i-1)},me=()=>{if(l==="FEEDBACK")return;const e=i===t.test_questions.length-1,r=b[s.id];if(e&&!m&&r&&r!=="__timeout__"){H(!0),L(r);return}const n=J();W(n),I(!0)},pe=((t==null?void 0:t.test_questions)||[]).filter(e=>w(e)).length,xe=(Y=t==null?void 0:t.test_questions)!=null&&Y.length?pe/t.test_questions.length*100:0,ge=()=>{P(!1),U(!1)},he=e=>{if(typeof e!="string")return!1;const r=e.trim();return!!(/^data:image\//i.test(r)||/^https?:\/\/.+\.(png|jpe?g|gif|svg|webp)(\?.*)?$/i.test(r)||/^[\w.\-\/]+?\.(png|jpe?g|gif|svg|webp)$/i.test(r))},Ce=(b[s==null?void 0:s.id]==="__timeout__"?"":b[s==null?void 0:s.id]||(s==null?void 0:s.user_answer)||"").toString().toLowerCase(),J=()=>{var n;const e=((n=t==null?void 0:t.test_questions)==null?void 0:n.length)||0;return{correct:((t==null?void 0:t.test_questions)||[]).reduce((p,d)=>{const x=b[d.id],j=x&&x!=="__timeout__"?x.toUpperCase():d.user_answer||null;return j?p+(j===d.correct_answer?1:0):p},0),total:e}},_e=()=>{we.Inertia.get(route("student.subject.index"))};return s?o.jsxs(o.Fragment,{children:[o.jsx(Pe,{sx:{mb:h?2:1,mt:h?2:1,mx:h?"auto":1,width:h?"60%":"100%",borderRadius:3,boxShadow:3,backgroundColor:"rgba(255,255,255,0.95)",border:"1px solid #e0e0e0"},children:o.jsxs(Ue,{sx:{backgroundColor:`${c.color}80`,borderTopLeftRadius:"12px",borderTopRightRadius:"12px"},children:[o.jsx(_,{variant:"h6",gutterBottom:!0,children:c.name}),o.jsx(Q,{variant:"determinate",value:xe})]})}),o.jsx(S,{sx:{mt:4,mb:2,px:1,display:"flex",alignItems:"flex-start",justifyContent:"center",minHeight:"calc(100vh - 220px)"},children:o.jsxs(Ie,{elevation:3,sx:{width:"100%",maxWidth:h?600:"95%",p:3,borderRadius:3,boxShadow:3,backgroundColor:"rgba(255,255,255,0.95)",border:"1px solid #e0e0e0"},children:[M&&o.jsx(Q,{variant:"determinate",value:oe/M*100,sx:{mt:2,height:10,borderRadius:5}}),o.jsxs(_,{variant:"subtitle1",gutterBottom:!0,sx:{marginBottom:"25px"},children:["Pregunta ",i+1," de ",t.test_questions.length]}),(s==null?void 0:s.type)==="image"?o.jsx(S,{component:"img",src:`${s.question_text}`,alt:"Pregunta",sx:{width:"100%",maxWidth:350,maxHeight:350,height:"auto",display:"block",mx:"auto",mb:4}}):o.jsx(_,{variant:"h6",sx:{mb:"20px"},gutterBottom:!0,children:s.question_text}),o.jsx(Me,{value:Ce,onChange:m||l==="FEEDBACK"?void 0:le,children:Object.entries(JSON.parse(s.options)).filter(([e,r])=>r!=null&&r!=="").map(([e,r])=>{const n=String(r).trim();return o.jsx(qe,{value:e,control:o.jsx($e,{disabled:m||l==="FEEDBACK"}),disabled:m||l==="FEEDBACK",sx:{mb:2,mt:"15px",...m?{opacity:.8}:{}},label:he(n)?o.jsx(S,{component:"img",src:n,alt:`Opción ${e.toUpperCase()}`,sx:{width:70,height:70,objectFit:"contain",border:"1px solid #ccc",p:1}}):`${e.toUpperCase()}: ${n}`},e)})}),o.jsxs(Oe,{direction:"row",justifyContent:"space-between",mt:3,children:[o.jsx(E,{variant:"outlined",onClick:fe,disabled:i===0||l==="FEEDBACK",children:"Anterior"}),i<t.test_questions.length-1?o.jsx(E,{variant:"contained",onClick:ue,disabled:l==="FEEDBACK",children:"Siguiente"}):o.jsx(E,{variant:"contained",color:"success",onClick:me,disabled:l==="FEEDBACK",children:"Finalizar"})]}),C?o.jsx(Le,{in:te,timeout:{enter:300,exit:300},children:o.jsxs(S,{sx:{mt:2,p:2,borderRadius:2,backgroundColor:C==="correct"?"#dcfce7":"#fee2e2",color:C==="correct"?"#15803d":"#b91c1c",display:"flex",alignItems:"center",gap:2},children:[o.jsx("img",{src:C==="correct"?"/assets/correct.gif":"/assets/incorrect.gif",alt:"feedback gif",style:{height:70}}),o.jsx(_,{variant:"h6",children:C==="correct"?"¡Muy bien! Respuesta correcta.":C==="timeout"?`Tiempo agotado. La respuesta correcta era: ${N}`:`Incorrecto. La respuesta correcta era: ${N}`})]})}):null,m?o.jsxs(_,{variant:"h5",sx:{mb:2},children:["Correcta: ",o.jsx("strong",{children:ae})]}):null]})}),o.jsx(Je,{open:y,close:ge,message:s==null?void 0:s.feedback_text,image:s==null?void 0:s.feedback_image}),o.jsx(Ke,{open:ne,onClose:()=>I(!1),correct:O.correct,total:O.total,onGoToSubjects:_e,showReview:!0})]}):null}export{ht as default};
