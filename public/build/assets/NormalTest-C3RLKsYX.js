import{r as a,j as t,a as fe}from"./app-DO6qCxou.js";import{d as pe}from"./index-Dfax6VI6.js";import{D as H}from"./Dialog-Cp41nx3x.js";import{D as z,a as G,b as V}from"./DialogTitle-Dw7wOr-I.js";import{a as he,g as ge,b as je,s as _e,i as be,c as Ce,T as g,r as we,C as ve,u as Se}from"./Typography-hDusPIBd.js";import{B as R}from"./Button-aaGi_c7-.js";import{S as X}from"./Slide-Chb7p4NG.js";import{B as j}from"./Box-DECm0aEA.js";import{u as N}from"./index-BKZ9OXpj.js";import{C as ye}from"./Card-UBjRlPVS.js";import{C as Re}from"./CardContent-CNNr1Dww.js";import{L as O}from"./LinearProgress-w_Y0VxrK.js";import{P as ke,F as Te}from"./Fade-4O_EcEW8.js";import{R as Ie,a as De}from"./RadioGroup-BnuxyiU6.js";import{F as Fe,S as Pe}from"./Stack-7sRDgMhN.js";import"./Modal-D08ns42k.js";import"./debounce-Be36O1Ab.js";import"./getThemeProps-BA-uR2tL.js";import"./index-Dw4eyy0A.js";import"./createSvgIcon-BMLBpFZC.js";import"./useFormControl-DdFt1Bxj.js";import"./FormGroup-DYsHNgHe.js";import"./useThemeProps-DABPkhOr.js";function Ae(s){return he("MuiDialogContentText",s)}ge("MuiDialogContentText",["root"]);const Ee=s=>{const{classes:l}=s,c=Ce({root:["root"]},Ae,l);return{...l,...c}},Le=_e(g,{shouldForwardProp:s=>we(s)||s==="classes",name:"MuiDialogContentText",slot:"Root"})({}),Me=a.forwardRef(function(l,d){const c=je({props:l,name:"MuiDialogContentText"}),{children:D,className:i,...u}=c,x=Ee(u);return t.jsx(Le,{component:"p",variant:"body1",color:"textSecondary",ref:d,ownerState:u,className:be(x.root,i),...c,classes:x})}),Be=a.forwardRef(function(l,d){return t.jsx(X,{direction:"up",ref:d,...l})});function Ue({open:s,close:l,message:d,image:c}){return t.jsx(a.Fragment,{children:t.jsxs(H,{open:s,slots:{transition:Be},keepMounted:!0,onClose:l,"aria-describedby":"alert-dialog-slide-description",PaperProps:{sx:{borderRadius:4}},children:[t.jsx(z,{children:"Explicación"}),t.jsx(G,{children:t.jsxs(Me,{id:"alert-dialog-slide-description",children:[d,c&&t.jsx("div",{style:{display:"flex",justifyContent:"center",margin:"20px 0"},children:t.jsx("img",{src:c,alt:"feedback image",style:{height:300,width:"auto"}})})]})}),t.jsx(V,{children:t.jsx(R,{onClick:l,children:"Cerrar"})})]})})}const qe="/build/assets/result_video-BNB9BkEU.mp4",$e=s=>t.jsx(X,{direction:"up",...s});function We({open:s,onClose:l,correct:d=0,total:c=0,onGoToSubjects:D}){const i=c>0?Math.round(d/c*100):0,[u,x]=a.useState(0),[k,r]=a.useState(0),C=a.useRef(null);let h="";return i>=90?h="¡Excelente resultado!":i>=70?h="¡Bien hecho!":h="Necesitas mejorar, sigue practicando.",a.useEffect(()=>{if(!s)return;x(0),r(0);const f=1200,p=16,y=Math.ceil(f/p);let w=0;const v=setInterval(()=>{w+=1;const T=Math.min(i,Math.round(w/y*i));x(T),r(T),w>=y&&clearInterval(v)},p);return()=>clearInterval(v)},[s,i]),a.useEffect(()=>{const f=C.current;if(f)if(s){f.currentTime=1,f.play();const p=setInterval(()=>{f.currentTime>=5&&(f.pause(),clearInterval(p))},200);return()=>clearInterval(p)}else f.pause()},[s]),t.jsxs(H,{open:s,onClose:l,fullWidth:!0,maxWidth:"xs",TransitionComponent:$e,PaperProps:{sx:{borderRadius:3,overflow:"hidden",position:"relative",backgroundColor:"transparent",minHeight:600}},children:[t.jsx(j,{sx:{position:"absolute",inset:0,zIndex:0,opacity:1,overflow:"hidden",minHeight:650},children:t.jsx("video",{ref:C,src:qe,muted:!0,playsInline:!0,style:{width:"100%",height:"100%",objectFit:"cover"}})}),t.jsxs(j,{sx:{position:"relative",zIndex:1,backgroundColor:"rgba(255,255,255,0.85)",minHeight:650},children:[t.jsx(z,{sx:{fontWeight:700},children:"¡Test terminado!"}),t.jsx(G,{children:t.jsxs(j,{sx:{display:"grid",placeItems:"center",my:20},children:[t.jsxs(j,{sx:{position:"relative",display:"inline-flex"},children:[t.jsx(ve,{variant:"determinate",value:u,size:140,thickness:5}),t.jsx(j,{sx:{top:0,left:0,bottom:0,right:0,position:"absolute",display:"flex",alignItems:"center",justifyContent:"center",flexDirection:"column"},children:t.jsxs(g,{variant:"h4",sx:{fontWeight:800},children:[k,"%"]})})]}),t.jsxs(g,{variant:"h6",sx:{mt:2,fontWeight:700},children:[d," de ",c]}),t.jsxs(g,{variant:"overline",color:"text.secondary",sx:{mt:.5},children:[t.jsx("strong",{children:h})," Tu porcentaje es ",i,"%."]})]})}),t.jsxs(V,{sx:{px:3,pb:2,gap:1},children:[t.jsx(R,{variant:"contained",onClick:l,fullWidth:!0,children:"Revisar"}),t.jsx(R,{variant:"contained",onClick:D,color:"primary",fullWidth:!0,children:"Ir a materias"})]})]})]})}function xt({test:s,subject:l}){const d=Se(),c=N(d.breakpoints.up("md")),D=N(d.breakpoints.down("sm")),[i,u]=a.useState(0),[x,k]=a.useState({}),r=s.test_questions[i],[C,h]=a.useState(null),[f,p]=a.useState(null),[y,w]=a.useState(!1),[v,T]=a.useState(!1),[J,P]=a.useState(null),[M,B]=a.useState(null),[K,U]=a.useState(!1),A=a.useRef(new Set),q=a.useRef(new Set),[Y,$]=a.useState(!1),[W,Z]=a.useState({correct:0,total:0}),Q=String((r==null?void 0:r.correct_answer)||"").toUpperCase(),I=e=>(e==null?void 0:e.is_correct)!==null||!!(e!=null&&e.user_answer),ee=e=>{const n={};return e.forEach(o=>{o.user_answer&&(n[o.id]=String(o.user_answer).toLowerCase())}),n},te=e=>{const n=e.findIndex(o=>!I(o));return n===-1?0:n},F=(e,n)=>{for(let o=n+1;o<e.length;o++)if(!I(e[o]))return o;return null},_=r?I(r)||q.current.has(r.id):!1;a.useEffect(()=>{var e;(e=s==null?void 0:s.test_questions)!=null&&e.length&&(k(ee(s.test_questions)),u(te(s.test_questions)))},[s==null?void 0:s.id]),a.useEffect(()=>{if(!y||v)return;const e=setTimeout(()=>{le()},2500);return()=>clearTimeout(e)},[y,v]),a.useEffect(()=>{if(!r)return;if(I(r)){P(null),B(null);return}const e=(r==null?void 0:r.limit_time)??null;if(P(e),B(e),!e)return;const n=setInterval(()=>{P(o=>o===null?o:o<=1?(clearInterval(n),E(null,!0),0):o-1)},1e3);return()=>clearInterval(n)},[r]);const se=e=>{_||k(n=>({...n,[r.id]:e.target.value.toLowerCase()}))},E=(e="",n=!1)=>{if(_)return;const o=(e||"").toLowerCase(),b=o.toUpperCase(),m=!n&&b===r.correct_answer;q.current.add(r.id),k(S=>({...S,[r.id]:n?"__timeout__":o})),n||(h(m?"correct":"incorrect"),m||p(r.correct_answer),!m&&(r.feedback_text||r.feedback_image)&&(T(!0),U(!0)),w(!0)),re({test_id:s==null?void 0:s.id,subject_id:(l==null?void 0:l.id)??null,current_question:r,is_correct:n?0:m?1:0,user_answer:n?null:b}),setTimeout(()=>w(!1),5e3)},re=async e=>{var S;const n=`${e.test_id}:${(S=e.current_question)==null?void 0:S.question_id}`;if(A.current.has(n))return;A.current.add(n);const o=new AbortController,b=setTimeout(()=>o.abort("timeout"),4e3);try{await fe.post(route("answer.save"),e,{signal:o.signal,headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json"}})}catch(L){L.message==="timeout"||L.code==="ERR_CANCELED"?console.warn("⏳ La petición se canceló por timeout (4s)."):console.error("❌ Error al enviar respuesta",L),A.current.delete(n)}finally{clearTimeout(b)}const m=F(s.test_questions,i);m!==null?u(m):i<s.test_questions.length-1&&u(i+1)},ne=()=>{if(_){const n=F(s.test_questions,i);n!==null?u(n):i<s.test_questions.length-1&&u(i+1);return}const e=x[r.id];e&&e!=="__timeout__"&&(E(e),setTimeout(()=>{h(null),p(null)},3e3))},oe=()=>{i>0&&u(i-1)},ie=()=>{const e=x[r.id];e&&e!=="__timeout__"&&E(e);const n=xe();Z(n),$(!0)},ae=s.test_questions.filter(e=>I(e)).length/s.test_questions.length*100,le=()=>{const e=F(s.test_questions,i);e!==null?u(e):i<s.test_questions.length-1&&u(i+1),h(null),p(null),w(!1)},ce=()=>{T(!1),U(!1);const e=F(s.test_questions,i);e!==null?u(e):i<s.test_questions.length-1&&u(i+1)},ue=e=>{if(typeof e!="string")return!1;const n=e.trim();return!!(/^data:image\//i.test(n)||/^https?:\/\/.+\.(png|jpe?g|gif|svg|webp)(\?.*)?$/i.test(n)||/^[\w.\-\/]+?\.(png|jpe?g|gif|svg|webp)$/i.test(n))},de=(x[r.id]==="__timeout__"?"":x[r.id]||(r==null?void 0:r.user_answer)||"").toString().toLowerCase(),xe=()=>{const e=s.test_questions.length;return{correct:s.test_questions.reduce((o,b)=>{const m=x[b.id],S=m&&m!=="__timeout__"?m.toUpperCase():b.user_answer||null;return S?o+(S===b.correct_answer?1:0):o},0),total:e}},me=()=>{pe.Inertia.get(route("student.subject.index"))};return t.jsxs(t.Fragment,{children:[t.jsx(ye,{sx:{mb:c?2:1,mt:c?2:1,mx:c?"auto":1,width:c?"60%":"100%",borderRadius:3,boxShadow:3,backgroundColor:"rgba(255,255,255,0.95)",border:"1px solid #e0e0e0"},children:t.jsxs(Re,{sx:{backgroundColor:`${l.color}80`,borderTopLeftRadius:"12px",borderTopRightRadius:"12px"},children:[t.jsx(g,{variant:"h6",gutterBottom:!0,children:l.name}),t.jsx(O,{variant:"determinate",value:ae})]})}),t.jsx(j,{sx:{mt:4,mb:2,px:1,display:"flex",alignItems:"flex-start",justifyContent:"center",minHeight:"calc(100vh - 220px)"},children:t.jsxs(ke,{elevation:3,sx:{width:"100%",maxWidth:c?600:"95%",p:3,borderRadius:3,boxShadow:3,backgroundColor:"rgba(255,255,255,0.95)",border:"1px solid #e0e0e0"},children:[M&&t.jsx(O,{variant:"determinate",value:J/M*100,sx:{mt:2,height:10,borderRadius:5}}),t.jsxs(g,{variant:"subtitle1",gutterBottom:!0,children:["Pregunta ",i+1," de ",s.test_questions.length]}),r.type==="image"?t.jsx(j,{component:"img",src:`${r.question_text}`,alt:"Pregunta",sx:{width:"100%",maxWidth:350,maxHeight:350,height:"auto",display:"block",mx:"auto",mb:4}}):t.jsx(g,{variant:"h6",sx:{marginBottom:"20px"},gutterBottom:!0,children:r.question_text}),t.jsx(Ie,{value:de,onChange:_?void 0:se,children:Object.entries(JSON.parse(r.options)).filter(([e,n])=>n!=null&&n!=="").map(([e,n])=>{const o=String(n).trim();return t.jsx(Fe,{value:e,control:t.jsx(De,{disabled:_}),disabled:_,sx:{mb:2,marginTop:"15px",..._?{opacity:.8}:{}},label:ue(o)?t.jsx(j,{component:"img",src:o,alt:`Opción ${e.toUpperCase()}`,sx:{width:70,height:70,objectFit:"contain",border:"1px solid #ccc",p:1}}):`${e.toUpperCase()}: ${o}`},e)})}),t.jsx(Te,{in:y,timeout:{enter:300,exit:1e3},onExited:()=>{h(null),p(null)},children:t.jsxs(j,{sx:{mt:2,p:2,borderRadius:2,backgroundColor:C==="correct"?"#dcfce7":"#fee2e2",color:C==="correct"?"#15803d":"#b91c1c",display:"flex",alignItems:"center",gap:2},children:[t.jsx("img",{src:C==="correct"?"/assets/correct.gif":"/assets/incorrect.gif",alt:"feedback gif",style:{height:70}}),t.jsx(g,{variant:"h6",children:C==="correct"?"¡Muy bien! Respuesta correcta.":`Incorrecto. La respuesta correcta era: ${f}`})]})}),_&&t.jsxs(g,{variant:"h5",sx:{mb:2},children:["Correcta: ",t.jsx("strong",{children:Q})]}),t.jsxs(Pe,{direction:"row",justifyContent:"space-between",mt:3,children:[t.jsx(R,{variant:"outlined",onClick:oe,disabled:i===0,children:"Anterior"}),i<s.test_questions.length-1?t.jsx(R,{variant:"contained",onClick:ne,children:"Siguiente"}):t.jsx(R,{variant:"contained",color:"success",onClick:ie,children:"Finalizar"})]})]})}),t.jsx(Ue,{open:v,close:ce,message:r==null?void 0:r.feedback_text,image:r==null?void 0:r.feedback_image}),t.jsx(We,{open:Y,onClose:()=>$(!1),correct:W.correct,total:W.total,onGoToSubjects:me})]})}export{xt as default};
