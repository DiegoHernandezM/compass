import{r as a,j as o,a as je}from"./app-B7ReyxME.js";import{d as Se}from"./index-Dxnq5vMG.js";import{D as Ee}from"./Dialog-DwUr00QK.js";import{D as Fe,a as Re}from"./DialogTitle-wmsFBIiO.js";import{a as De,g as Ae,b as ke,s as ve,i as ye,d as Te,T as _,r as Be,u as Ie,P as Le,ag as Ne}from"./Modal-CmdoprVN.js";import{D as Pe}from"./DialogActions-Ca704N5F.js";import{B as E}from"./Button-nha7iH1_.js";import{S as Ke,u as Z}from"./index-DtKEcLQx.js";import{T as Ue}from"./TestResultDialog-CYcK7uy1.js";import{C as Me}from"./Card-CBCRNrh1.js";import{C as $e}from"./CardContent-Dkpi7NLe.js";import{L as Q}from"./LinearProgress-C6B1AS6f.js";import{B as S}from"./Box-D88nVR9t.js";import{R as qe,a as Oe}from"./RadioGroup-BX3PzWzi.js";import{F as We,S as Ge}from"./Stack-Cg2j-r8D.js";import"./getThemeProps-B4OaKWPX.js";import"./index-C5xoNR8g.js";import"./createSvgIcon-NHobGvps.js";import"./useFormControl-CeJN69-X.js";import"./useControlled-B2F6Uwsg.js";import"./FormGroup-BsjnD4Qd.js";import"./useThemeProps-DgFUl8jJ.js";function He(t){return De("MuiDialogContentText",t)}Ae("MuiDialogContentText",["root"]);const Xe=t=>{const{classes:c}=t,u=Te({root:["root"]},He,c);return{...c,...u}},ze=ve(_,{shouldForwardProp:t=>Be(t)||t==="classes",name:"MuiDialogContentText",slot:"Root"})({}),Je=a.forwardRef(function(c,g){const u=ke({props:c,name:"MuiDialogContentText"}),{children:h,className:F,...i}=u,f=Xe(i);return o.jsx(ze,{component:"p",variant:"body1",color:"textSecondary",ref:g,ownerState:i,className:ye(f.root,F),...u,classes:f})}),Ve=a.forwardRef(function(c,g){return o.jsx(Ke,{direction:"up",ref:g,...c})});function Ye({open:t,close:c,message:g,image:u}){return o.jsx(a.Fragment,{children:o.jsxs(Ee,{open:t,slots:{transition:Ve},keepMounted:!0,onClose:c,"aria-describedby":"alert-dialog-slide-description",PaperProps:{sx:{borderRadius:4}},children:[o.jsx(Fe,{children:"Explicación"}),o.jsx(Re,{children:o.jsxs(Je,{id:"alert-dialog-slide-description",children:[g,u&&o.jsx("div",{style:{display:"flex",justifyContent:"center",margin:"20px 0"},children:o.jsx("img",{src:u,alt:"feedback image",style:{height:300,width:"auto"}})})]})}),o.jsx(Pe,{children:o.jsx(E,{onClick:c,children:"Cerrar"})})]})})}function bt({test:t,subject:c,type:g}){var V,Y;const u=Ie(),h=Z(u.breakpoints.up("md")),F=Z(u.breakpoints.down("sm")),[i,f]=a.useState(0),[w,R]=a.useState({}),s=(V=t==null?void 0:t.test_questions)==null?void 0:V[i],[C,D]=a.useState(null),[N,ee]=a.useState(null),[te,A]=a.useState(!1),[se,re]=a.useState(!1),[l,k]=a.useState("ANSWERING"),[v,P]=a.useState(null),oe=1500,ne=2500,[y,K]=a.useState(!1),[Ze,U]=a.useState(!1),[ae,T]=a.useState(null),[M,$]=a.useState(null),B=a.useRef(new Set),q=a.useRef(new Set),[ie,I]=a.useState(!1),[O,W]=a.useState({correct:0,total:0}),ce=String((s==null?void 0:s.correct_answer)||"").toUpperCase(),[G,H]=a.useState(!1),b=e=>(e==null?void 0:e.is_correct)!==null||!!(e!=null&&e.user_answer),le=e=>{const r={};return e.forEach(n=>{n.user_answer&&(r[n.id]=String(n.user_answer).toLowerCase())}),r},de=e=>{const r=e.findIndex(n=>!b(n));return r===-1?0:r},X=(e,r)=>{for(let n=r+1;n<e.length;n++)if(!b(e[n]))return n;return null},x=s?b(s)||q.current.has(s.id):!1,z=l==="FEEDBACK";a.useEffect(()=>{var e;(e=t==null?void 0:t.test_questions)!=null&&e.length&&(R(le(t.test_questions)),f(de(t.test_questions)),k("ANSWERING"),D(null),A(!1),P(null))},[t==null?void 0:t.id]),a.useEffect(()=>{["/assets/correct.gif","/assets/incorrect.gif"].forEach(e=>{const r=new Image;r.src=e})},[]),a.useEffect(()=>{if(!s)return;if(b(s)){T(null),$(null);return}const e=(s==null?void 0:s.limit_time)??null;if(T(e),$(e),!e||z)return;const r=setInterval(()=>{T(n=>n===null?n:n<=1?(clearInterval(r),L(null,!0),0):n-1)},1e3);return()=>clearInterval(r)},[s,z]),a.useEffect(()=>{if(l!=="FEEDBACK"||!v||y)return;const e=Math.max(0,v-Date.now()),r=setTimeout(()=>{if(A(!1),k("ANSWERING"),D(null),G){H(!1);const m=J();W(m),I(!0);return}const n=X(t.test_questions,i);n!==null?f(n):i<t.test_questions.length-1&&f(i+1)},e);return()=>clearTimeout(r)},[l,v,y,i,G,t==null?void 0:t.test_questions]);const ue=e=>{x||l==="FEEDBACK"||R(r=>({...r,[s.id]:e.target.value.toLowerCase()}))},L=(e="",r=!1)=>{if(x)return;const n=(e||"").toLowerCase(),m=n.toUpperCase(),d=!r&&m===s.correct_answer;q.current.add(s.id),R(j=>({...j,[s.id]:r?"__timeout__":n})),D(r?"timeout":d?"correct":"incorrect"),d||ee(s.correct_answer),!d&&!r&&(s.feedback_text||s.feedback_image)&&(K(!0),U(!0)),A(!0),k("FEEDBACK");const p=d?oe:ne;P(Date.now()+p),fe({test_id:t==null?void 0:t.id,subject_id:(c==null?void 0:c.id)??null,current_question:s,is_correct:r?0:d?1:0,user_answer:r?null:m})},fe=async e=>{var d;const r=`${e.test_id}:${(d=e.current_question)==null?void 0:d.question_id}`;if(B.current.has(r))return;B.current.add(r);const n=new AbortController,m=setTimeout(()=>n.abort("timeout"),4e3);try{await je.post(route("answer.save"),e,{signal:n.signal,headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json"}})}catch(p){p.message==="timeout"||p.code==="ERR_CANCELED"?console.warn("⏳ La petición se canceló por timeout (4s)."):console.error("❌ Error al enviar respuesta",p),B.current.delete(r)}finally{clearTimeout(m)}},me=()=>{if(l==="FEEDBACK")return;if(x){const r=X(t.test_questions,i);r!==null?f(r):i<t.test_questions.length-1&&f(i+1);return}const e=w[s.id];e&&e!=="__timeout__"&&L(e)},pe=()=>{l!=="FEEDBACK"&&i>0&&f(i-1)},xe=()=>{if(l==="FEEDBACK")return;const e=i===t.test_questions.length-1,r=w[s.id];if(e&&!x&&r&&r!=="__timeout__"){H(!0),L(r);return}const n=J();W(n),I(!0)},ge=((t==null?void 0:t.test_questions)||[]).filter(e=>b(e)).length,he=(Y=t==null?void 0:t.test_questions)!=null&&Y.length?ge/t.test_questions.length*100:0,Ce=()=>{K(!1),U(!1)},_e=e=>{if(typeof e!="string")return!1;const r=e.trim();return!!(/^data:image\//i.test(r)||/^https?:\/\/.+\.(png|jpe?g|gif|svg|webp)(\?.*)?$/i.test(r)||/^[\w.\-\/]+?\.(png|jpe?g|gif|svg|webp)$/i.test(r))},we=(w[s==null?void 0:s.id]==="__timeout__"?"":w[s==null?void 0:s.id]||(s==null?void 0:s.user_answer)||"").toString().toLowerCase(),J=()=>{var n;const e=((n=t==null?void 0:t.test_questions)==null?void 0:n.length)||0;return{correct:((t==null?void 0:t.test_questions)||[]).reduce((m,d)=>{const p=w[d.id],j=p&&p!=="__timeout__"?p.toUpperCase():d.user_answer||null;return j?m+(j===d.correct_answer?1:0):m},0),total:e}},be=()=>{Se.Inertia.get(route("student.subject.index"))};return s?o.jsxs(o.Fragment,{children:[o.jsx(Me,{sx:{mb:h?2:1,mt:h?2:1,mx:h?"auto":1,width:h?"60%":"100%",borderRadius:3,boxShadow:3,backgroundColor:"rgba(255,255,255,0.95)",border:"1px solid #e0e0e0"},children:o.jsxs($e,{sx:{backgroundColor:`${c.color}80`,borderTopLeftRadius:"12px",borderTopRightRadius:"12px"},children:[o.jsx(_,{variant:"h6",gutterBottom:!0,children:c.name}),o.jsx(Q,{variant:"determinate",value:he})]})}),o.jsx(S,{sx:{mt:4,mb:2,px:1,display:"flex",alignItems:"flex-start",justifyContent:"center",minHeight:"calc(100vh - 220px)"},children:o.jsxs(Le,{elevation:3,sx:{width:"100%",maxWidth:h?600:"95%",p:3,borderRadius:3,boxShadow:3,backgroundColor:"rgba(255,255,255,0.95)",border:"1px solid #e0e0e0"},children:[M&&o.jsx(Q,{variant:"determinate",value:ae/M*100,sx:{mt:2,height:10,borderRadius:5}}),o.jsxs(_,{variant:"subtitle1",gutterBottom:!0,sx:{marginBottom:"25px"},children:["Pregunta ",i+1," de ",t.test_questions.length]}),(s==null?void 0:s.type)==="image"?o.jsx(S,{component:"img",src:`${s.question_text}`,alt:"Pregunta",sx:{width:"100%",maxWidth:350,maxHeight:350,height:"auto",display:"block",mx:"auto",mb:4}}):o.jsx(_,{variant:"h6",sx:{mb:"20px"},gutterBottom:!0,children:s.question_text}),o.jsx(qe,{value:we,onChange:x||l==="FEEDBACK"?void 0:ue,children:Object.entries(JSON.parse(s.options)).filter(([e,r])=>r!=null&&r!=="").map(([e,r])=>{const n=String(r).trim();return o.jsx(We,{value:e,control:o.jsx(Oe,{disabled:x||l==="FEEDBACK"}),disabled:x||l==="FEEDBACK",sx:{mb:2,mt:"15px",...x?{opacity:.8}:{}},label:_e(n)?o.jsx(S,{component:"img",src:n,alt:`Opción ${e.toUpperCase()}`,sx:{width:70,height:70,objectFit:"contain",border:"1px solid #ccc",p:1}}):`${e.toUpperCase()}: ${n}`},e)})}),o.jsxs(Ge,{direction:"row",justifyContent:"space-between",mt:3,children:[o.jsx(E,{variant:"outlined",onClick:pe,disabled:i===0||l==="FEEDBACK",children:"Anterior"}),i<t.test_questions.length-1?o.jsx(E,{variant:"contained",onClick:me,disabled:l==="FEEDBACK",children:"Siguiente"}):o.jsx(E,{variant:"contained",color:"success",onClick:xe,disabled:l==="FEEDBACK",children:"Finalizar"})]}),C?o.jsx(Ne,{in:te,timeout:{enter:300,exit:300},children:o.jsxs(S,{sx:{mt:2,p:2,borderRadius:2,backgroundColor:C==="correct"?"#dcfce7":"#fee2e2",color:C==="correct"?"#15803d":"#b91c1c",display:"flex",alignItems:"center",gap:2},children:[o.jsx("img",{src:C==="correct"?"/assets/correct.gif":"/assets/incorrect.gif",alt:"feedback gif",style:{height:70}}),o.jsx(_,{variant:"h6",children:C==="correct"?"¡Muy bien! Respuesta correcta.":C==="timeout"?`Tiempo agotado. La respuesta correcta era: ${N}`:`Incorrecto. La respuesta correcta era: ${N}`})]})}):null,se?o.jsxs(_,{variant:"h5",sx:{mb:2},children:["Correcta: ",o.jsx("strong",{children:ce})]}):null]})}),o.jsx(Ye,{open:y,close:Ce,message:s==null?void 0:s.feedback_text,image:s==null?void 0:s.feedback_image}),o.jsx(Ue,{open:ie,onClose:()=>I(!1),correct:O.correct,total:O.total,onGoToSubjects:be,showReview:!0,setReview:()=>re(!0)})]}):null}export{bt as default};
