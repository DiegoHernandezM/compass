import{r as o,j as r,a as ce}from"./app-CTwrnCSa.js";import{d as le}from"./index-C5gVxXuk.js";import{T as ue}from"./TestResultDialog-DJcIThd0.js";import{u as de,T as h,ag as me}from"./Modal-DvGMwPj2.js";import{u as $}from"./index-D_oAqWYk.js";import{C as K}from"./Card-CbK-P5lb.js";import{C as z}from"./CardContent-zmMVSIpR.js";import{B as f}from"./Box-hGrso6gg.js";import{L as fe}from"./LinearProgress-DGYI7chS.js";import{B as Q}from"./Button-DOZfjLr6.js";import"./Dialog-C5hNsxli.js";import"./DialogTitle-CIJOSfgz.js";import"./Slide-Ccf0mSjh.js";import"./getThemeProps-CPAOgBEp.js";import"./index-C8n_aWei.js";function Ee({test:a,subject:l}){const I=de(),g=$(I.breakpoints.up("md")),W=$(I.breakpoints.down("sm")),[b,E]=o.useState(0),[v,M]=o.useState(!0),[S,X]=o.useState({}),[w,D]=o.useState([]),[R,L]=o.useState({}),[p,P]=o.useState(null),[G,k]=o.useState(null),[_,A]=o.useState(0),[B,J]=o.useState(0),j=o.useRef(new Set),i=a.test_questions||[],u=i[b],N=e=>(e==null?void 0:e.is_correct)!==null,[Y,F]=o.useState(!1),[H,y]=o.useState({correct:0,total:i.length}),[m,O]=o.useState({});o.useEffect(()=>{const e={};for(const t of i)(t.is_correct===0||t.is_correct===1)&&(e[t.id]=t.is_correct);O(e)},[a==null?void 0:a.id]),o.useEffect(()=>{if(!i.length)return;const e=i.findIndex(t=>!N(t));E(e===-1?0:e)},[a==null?void 0:a.id]),o.useEffect(()=>{y(T(m))},[b,m]),o.useEffect(()=>{if(!u)return;M(!0),L({}),P(null),k(null);const e={};u.question_text.split(`
`).forEach(se=>{const[V,...q]=se.split(":");if(!V||!q.length)return;const ie=V.trim().toUpperCase(),ae=q.join(":").trim();e[ie]=ae}),X(e);const t=a.question_level_id,s=Object.keys(e),n=t===14?1:t===15?2:4,c=[...s].sort(()=>.5-Math.random());D(c.slice(0,Math.min(n,s.length)));const d=u.limit_time||5;A(d),J(d);const oe=setTimeout(()=>M(!1),d*1e3);return()=>clearTimeout(oe)},[u,a==null?void 0:a.question_level_id]),o.useEffect(()=>{if(!v||_<=0)return;const e=setInterval(()=>A(t=>t-1),1e3);return()=>clearInterval(e)},[v,_]);const Z=(e,t)=>{L(s=>({...s,[e.toUpperCase()]:t}))},ee=e=>{var c;const t=`${e.test_id}:${(c=e.current_question)==null?void 0:c.id}`;if(j.current.has(t))return Promise.resolve();j.current.add(t);const s=new AbortController,n=setTimeout(()=>s.abort("timeout"),4e3);return ce.post(route("answer.save"),e,{signal:s.signal,headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json"}}).catch(d=>{console.error("❌ Error al enviar respuesta",d),j.current.delete(t)}).finally(()=>clearTimeout(n))},U=e=>{if(!e)return"";const t=Number(e);return isNaN(t)?e.toLowerCase().trim():Math.floor(t)},te=async()=>{if(!u)return;const e=w.find(n=>{const c=U(S[n]),d=U(R[n]);return c!==d}),t=!e;P(t?"correct":"incorrect"),t||k(S[e]),O(n=>{const c={...n,[u.id]:t?1:0};return y(T(c)),c});const s={};w.forEach(n=>{s[n]=R[n]??""}),await ee({test_id:a.id,subject_id:(l==null?void 0:l.id)??null,current_question:u,is_correct:t?1:0,user_answer:JSON.stringify(s)})},C=e=>m[e.id]!==void 0&&m[e.id]!==null?m[e.id]:e.is_correct,re=e=>{for(let t=e+1;t<i.length;t++)if(C(i[t])===null||C(i[t])===void 0)return t;for(let t=0;t<=e;t++)if(C(i[t])===null||C(i[t])===void 0)return t;return-1},ne=()=>{const e=re(b);if(e===-1){y(T(m)),F(!0);return}E(e)},x=u?N(u):!1,T=e=>{const t=i.length;let s=0;for(const n of i)(e[n.id]!==void 0&&e[n.id]!==null?e[n.id]:n.is_correct)===1&&(s+=1);return{correct:s,total:t}};return r.jsxs(r.Fragment,{children:[r.jsx(K,{sx:{mb:g?2:1,mt:g?2:1,mx:g?"auto":1,width:g?"60%":"100%",borderRadius:3,boxShadow:3,backgroundColor:"rgba(255,255,255,0.95)",border:"1px solid #e0e0e0"},children:r.jsx(z,{sx:{backgroundColor:`${l==null?void 0:l.color}80`,borderTopLeftRadius:"12px",borderTopRightRadius:"12px"},children:r.jsx(h,{variant:"h6",gutterBottom:!0,children:l==null?void 0:l.name})})}),r.jsx(f,{sx:{mt:4,mb:2,px:1,display:"flex",alignItems:"flex-start",justifyContent:"center",minHeight:"calc(100vh - 220px)"},children:r.jsx(K,{sx:{width:"100%",maxWidth:500,borderRadius:3,boxShadow:4},children:r.jsxs(z,{children:[r.jsx(fe,{variant:"determinate",value:B?_/B*100:0,sx:{mb:2,height:10,borderRadius:5}}),r.jsxs(h,{variant:"subtitle1",gutterBottom:!0,children:["Pregunta ",b+1," de ",i.length]}),r.jsx(f,{sx:{border:"2px solid #333",borderRadius:2,p:3,backgroundColor:"#000",color:"#0f0",fontFamily:"monospace",mt:2},children:Object.entries(S).map(([e,t])=>{const s=w.includes(e.toUpperCase()),n=v||!s||x;return r.jsxs(f,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2,children:[r.jsx(h,{children:e}),n?r.jsx(h,{children:t}):r.jsx("input",{type:"number",value:R[e]||"",onChange:c=>Z(e,c.target.value),disabled:x,style:{width:140,padding:6,borderRadius:6,backgroundColor:x?"#f1f1f1":"#fff",color:"#000",fontSize:"1rem",border:"1px solid #ccc"}})]},e)})}),!v&&!x&&r.jsx(f,{mt:4,textAlign:"center",children:p?r.jsx(me,{in:!0,children:r.jsx(f,{sx:{p:2,borderRadius:2,backgroundColor:p==="correct"?"#dcfce7":"#fee2e2",color:p==="correct"?"#15803d":"#b91c1c",display:"inline-block"},children:r.jsx(h,{variant:"h6",children:p==="correct"?"¡Muy bien! Respuesta correcta.":`Incorrecto. La respuesta correcta era: ${G}`})})}):r.jsx(Q,{variant:"contained",onClick:te,children:"Enviar respuesta"})}),(p||x)&&r.jsx(f,{mt:3,textAlign:"center",children:r.jsx(Q,{variant:"contained",onClick:ne,children:"Siguiente"})})]})})}),r.jsx(ue,{open:Y,onClose:()=>F(!1),correct:H.correct,total:H.total,onGoToSubjects:()=>le.Inertia.get(route("student.subject.index")),showReview:!1})]})}export{Ee as default};
