import{r as o,j as r,a as ae}from"./app-BEt_j3y4.js";import{d as le}from"./index-CFfXh916.js";import{T as de}from"./TestResultDialog-Kt5kzWWM.js";import{u as ue,T as x,ag as me}from"./Modal-lD_zqTbe.js";import{u as z}from"./index-DazhPLGl.js";import{C as K}from"./Card-DD9UwPwp.js";import{C as Q}from"./CardContent-DCnC0e5G.js";import{B as m}from"./Box-Dr-7W-DA.js";import{L as fe}from"./LinearProgress-bb-S99J7.js";import{B as W}from"./Button-CzMRS666.js";import"./Dialog-CJdmGbGA.js";import"./DialogTitle-CjaMSVqh.js";import"./getThemeProps-BKhbLW6y.js";import"./index-Do89Vuqu.js";function ke({test:a,subject:d}){const I=ue(),g=z(I.breakpoints.up("md")),X=z(I.breakpoints.down("sm")),[b,E]=o.useState(0),[S,M]=o.useState(!0),[P,G]=o.useState({}),[C,J]=o.useState([]),[j,A]=o.useState({}),[p,L]=o.useState(null),[Y,F]=o.useState([]),[R,B]=o.useState(0),[N,Z]=o.useState(0),_=o.useRef(new Set),i=a.test_questions||[],u=i[b],H=e=>(e==null?void 0:e.is_correct)!==null,[ee,O]=o.useState(!1),[U,y]=o.useState({correct:0,total:i.length}),[f,q]=o.useState({});o.useEffect(()=>{const e={};for(const t of i)(t.is_correct===0||t.is_correct===1)&&(e[t.id]=t.is_correct);q(e)},[a==null?void 0:a.id]),o.useEffect(()=>{if(!i.length)return;const e=i.findIndex(t=>!H(t));E(e===-1?0:e)},[a==null?void 0:a.id]),o.useEffect(()=>{y(T(f))},[b,f]),o.useEffect(()=>{if(!u)return;M(!0),A({}),L(null),F([]);const e={};u.question_text.split(`
`).forEach(k=>{const[D,...$]=k.split(":");if(!D||!$.length)return;const ie=D.trim().toUpperCase(),ce=$.join(":").trim();e[ie]=ce}),G(e);const t=a.question_level_id,s=Object.keys(e),c=t===14?1:t===15?2:4,n=[...s].sort(()=>.5-Math.random());J(n.slice(0,Math.min(c,s.length)));const l=u.limit_time||5;B(l),Z(l);const w=setTimeout(()=>M(!1),l*1e3);return()=>clearTimeout(w)},[u,a==null?void 0:a.question_level_id]),o.useEffect(()=>{if(!S||R<=0)return;const e=setInterval(()=>B(t=>t-1),1e3);return()=>clearInterval(e)},[S,R]);const te=(e,t)=>{A(s=>({...s,[e.toUpperCase()]:t}))},re=e=>{var n;const t=`${e.test_id}:${(n=e.current_question)==null?void 0:n.id}`;if(_.current.has(t))return Promise.resolve();_.current.add(t);const s=new AbortController,c=setTimeout(()=>s.abort("timeout"),4e3);return ae.post(route("answer.save"),e,{signal:s.signal,headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json"}}).catch(l=>{console.error("❌ Error al enviar respuesta",l),_.current.delete(t)}).finally(()=>clearTimeout(c))},V=e=>{if(e==null)return"";const t=Number(e);return!Number.isNaN(t)&&e!==""?Math.floor(t):String(e).toLowerCase().trim()},ne=async()=>{if(!u)return;const e=C.map(n=>{const l=P[n],w=j[n]??"",k=V(l)===V(w);return{key:n,expected:l,got:String(w),correct:k}}),s=e.filter(n=>!n.correct).length===0;L(s?"correct":"incorrect"),F(e),q(n=>{const l={...n,[u.id]:s?1:0};return y(T(l)),l});const c={};C.forEach(n=>{c[n]=j[n]??""}),await re({test_id:a.id,subject_id:(d==null?void 0:d.id)??null,current_question:u,is_correct:s?1:0,user_answer:JSON.stringify(c)})},v=e=>f[e.id]!==void 0&&f[e.id]!==null?f[e.id]:e.is_correct,oe=e=>{for(let t=e+1;t<i.length;t++)if(v(i[t])===null||v(i[t])===void 0)return t;for(let t=0;t<=e;t++)if(v(i[t])===null||v(i[t])===void 0)return t;return-1},se=()=>{const e=oe(b);if(e===-1){y(T(f)),O(!0);return}E(e)},h=u?H(u):!1,T=e=>{const t=i.length;let s=0;for(const c of i)(e[c.id]!==void 0&&e[c.id]!==null?e[c.id]:c.is_correct)===1&&(s+=1);return{correct:s,total:t}};return r.jsxs(r.Fragment,{children:[r.jsx(K,{sx:{mb:g?2:1,mt:g?2:1,mx:g?"auto":1,width:g?"60%":"100%",borderRadius:3,boxShadow:3,backgroundColor:"rgba(255,255,255,0.95)",border:"1px solid #e0e0e0"},children:r.jsx(Q,{sx:{backgroundColor:`${d!=null&&d.name?d.color:"#1976d2"}80`,borderTopLeftRadius:"12px",borderTopRightRadius:"12px"},children:r.jsx(x,{variant:"h6",gutterBottom:!0,children:d==null?void 0:d.name})})}),r.jsx(m,{sx:{mt:4,mb:2,px:1,display:"flex",alignItems:"flex-start",justifyContent:"center",minHeight:"calc(100vh - 220px)"},children:r.jsx(K,{sx:{width:"100%",maxWidth:500,borderRadius:3,boxShadow:4},children:r.jsxs(Q,{children:[r.jsx(fe,{variant:"determinate",value:N?R/N*100:0,sx:{mb:2,height:10,borderRadius:5}}),r.jsxs(x,{variant:"subtitle1",gutterBottom:!0,sx:{marginBottom:"25px"},children:["Pregunta ",b+1," de ",i.length]}),r.jsx(m,{sx:{border:"2px solid #333",borderRadius:2,p:3,backgroundColor:"#000",color:"#0f0",fontFamily:"monospace",mt:2},children:Object.entries(P).map(([e,t])=>{const s=C.includes(e.toUpperCase()),c=S||!s||h;return r.jsxs(m,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2,children:[r.jsx(x,{children:e}),c?r.jsx(x,{children:t}):r.jsx("input",{type:"number",value:j[e]||"",onChange:n=>te(e,n.target.value),disabled:h,style:{width:140,padding:6,borderRadius:6,backgroundColor:h?"#f1f1f1":"#fff",color:"#000",fontSize:"1rem",border:"1px solid #ccc"}})]},e)})}),!S&&!h&&r.jsx(m,{mt:4,textAlign:"center",children:p?r.jsx(me,{in:!0,children:r.jsx(m,{sx:{p:2,borderRadius:2,backgroundColor:p==="correct"?"#dcfce7":"#fee2e2",color:p==="correct"?"#15803d":"#b91c1c",display:"inline-block",textAlign:"left"},children:p==="correct"?r.jsx(x,{variant:"h6",children:"¡Muy bien! Respuesta correcta."}):r.jsxs(r.Fragment,{children:[r.jsx(x,{variant:"h6",sx:{mb:1},children:"Incorrecto. Valores correctos:"}),r.jsx(m,{component:"ul",sx:{pl:"1.2rem",m:0},children:Y.filter(e=>!e.correct).map(e=>r.jsxs("li",{children:[r.jsx("strong",{children:e.key}),": ",String(e.expected),e.got!==""?r.jsxs(r.Fragment,{children:[" (tu: ",String(e.got),")"]}):" (vacío)"]},e.key))})]})})}):r.jsx(W,{variant:"contained",onClick:ne,children:"Enviar respuesta"})}),(p||h)&&r.jsx(m,{mt:3,textAlign:"center",children:r.jsx(W,{variant:"contained",onClick:se,children:"Siguiente"})})]})})}),r.jsx(de,{open:ee,onClose:()=>O(!1),correct:U.correct,total:U.total,onGoToSubjects:()=>le.Inertia.get(route("student.subject.index")),showReview:!1})]})}export{ke as default};
