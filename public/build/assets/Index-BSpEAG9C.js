import{r as i,j as t,q as K,v as ie,$ as le}from"./app-ik-eAmJ5.js";import{A as de}from"./AuthenticatedLayout-QayYrQtU.js";import{B as n}from"./Box-Cttndrh7.js";import{S as Q}from"./Stack-Br5R0KKQ.js";import{A as V}from"./Alert-DRfIiPDo.js";import{g as ce,a as ue,b as me,c as y,T as v,s as $,d as pe,t as X,B as he,C as Z}from"./Modal-BfxBdzR4.js";import{C as ee}from"./Card-5qtjB0zA.js";import{C as te}from"./CardContent-2RkP_DXT.js";import{B as G}from"./Button-OIliXJSV.js";import{L as xe}from"./LinearProgress-CYm1DMd8.js";import{T as fe,F as ge,I as Ce,S as be}from"./TextField-C2CtAcpD.js";import{M as S}from"./ErrorAlert-CvJhnPpa.js";import{D as je}from"./Dialog-CyuD_uq0.js";import{D as we,a as ye}from"./DialogTitle-CoEkIcJc.js";import{D as Se}from"./DialogActions-BytgW6F4.js";import{D as ve}from"./DataGrid-Bblh2Ejc.js";import"./School-CEBIEtH0.js";import"./createSvgIcon-CuMBYvDD.js";import"./Logout-CpYH1Ofv.js";import"./isMuiElement-DxrUKZul.js";import"./index-lQH31EgS.js";import"./getThemeProps-PPnXgrHm.js";import"./index-D-Zzepmv.js";import"./useFormControl-rlPtyDFF.js";import"./useControlled-kdlTkz1j.js";import"./useThemeProps-Ccp135M-.js";import"./index-KnSCjt_-.js";import"./Tooltip-BeNaixxI.js";import"./TableCell-BXtXFFqj.js";function De(d){return ue("MuiCardHeader",d)}const F=ce("MuiCardHeader",["root","avatar","action","content","title","subheader"]),Te=d=>{const{classes:l}=d;return pe({root:["root"],avatar:["avatar"],action:["action"],content:["content"],title:["title"],subheader:["subheader"]},De,l)},Ne=$("div",{name:"MuiCardHeader",slot:"Root",overridesResolver:(d,l)=>[{[`& .${F.title}`]:l.title},{[`& .${F.subheader}`]:l.subheader},l.root]})({display:"flex",alignItems:"center",padding:16}),Pe=$("div",{name:"MuiCardHeader",slot:"Avatar"})({display:"flex",flex:"0 0 auto",marginRight:16}),ke=$("div",{name:"MuiCardHeader",slot:"Action"})({flex:"0 0 auto",alignSelf:"flex-start",marginTop:-4,marginRight:-8,marginBottom:-4}),He=$("div",{name:"MuiCardHeader",slot:"Content"})({flex:"1 1 auto",[`.${X.root}:where(& .${F.title})`]:{display:"block"},[`.${X.root}:where(& .${F.subheader})`]:{display:"block"}}),se=i.forwardRef(function(l,x){const k=me({props:l,name:"MuiCardHeader"}),{action:D,avatar:c,component:T="div",disableTypography:f=!1,subheader:A,subheaderTypographyProps:N,title:M,titleTypographyProps:H,slots:I={},slotProps:W={},...P}=k,u={...k,component:T,disableTypography:f},p=Te(u),h={slots:I,slotProps:{title:H,subheader:N,...W}};let g=M;const[b,j]=y("title",{className:p.title,elementType:v,externalForwardedProps:h,ownerState:u,additionalProps:{variant:c?"body2":"h5",component:"span"}});g!=null&&g.type!==v&&!f&&(g=t.jsx(b,{...j,children:g}));let C=A;const[R,_]=y("subheader",{className:p.subheader,elementType:v,externalForwardedProps:h,ownerState:u,additionalProps:{variant:c?"body2":"body1",color:"textSecondary",component:"span"}});C!=null&&C.type!==v&&!f&&(C=t.jsx(R,{..._,children:C}));const[U,B]=y("root",{ref:x,className:p.root,elementType:Ne,externalForwardedProps:{...h,...P,component:T},ownerState:u}),[L,w]=y("avatar",{className:p.avatar,elementType:Pe,externalForwardedProps:h,ownerState:u}),[O,z]=y("content",{className:p.content,elementType:He,externalForwardedProps:h,ownerState:u}),[E,q]=y("action",{className:p.action,elementType:ke,externalForwardedProps:h,ownerState:u});return t.jsxs(U,{...B,children:[c&&t.jsx(L,{...w,children:c}),t.jsxs(O,{...z,children:[g,C]}),D&&t.jsx(E,{...q,children:D})]})});function nt(){var Y;const{props:d}=K(),l=K().props.latest??[],x=((Y=d==null?void 0:d.flash)==null?void 0:Y.success)??null,[k,D]=i.useState(!!x),[c,T]=i.useState(!1),[f,A]=i.useState(""),[N,M]=i.useState("all"),H=e=>new Date(e.getFullYear(),e.getMonth(),e.getDate()),I=e=>{if(!e)return null;if(e instanceof Date)return isNaN(e.getTime())?null:e;if(typeof e=="string"){const r=e.trim();if(/^\d{4}-\d{2}-\d{2}/.test(r)){const m=r.includes("T")?r:r.replace(" ","T"),o=new Date(m);return isNaN(o.getTime())?null:o}if(/^\d{2}-\d{2}-\d{4}$/.test(r)){const[m,o,ne]=r.split("-"),J=new Date(Number(ne),Number(o)-1,Number(m));return isNaN(J.getTime())?null:J}const a=new Date(r);return isNaN(a.getTime())?null:a}const s=new Date(e);return isNaN(s.getTime())?null:s},[W,P]=i.useState(!1),[u,p]=i.useState("Detalle"),[h,g]=i.useState(""),[b,j]=i.useState(!1),C=e=>{var r,a;if(console.log(e),e.field!=="description")return;const s=((r=e==null?void 0:e.row)==null?void 0:r.description)??"";s&&(p(`Ticket ${((a=e==null?void 0:e.row)==null?void 0:a.ticket_number)??""}`),g(s),P(!0))},{data:R,setData:_,post:U,reset:B,errors:L,progress:w}=ie({file:null});i.useEffect(()=>{x&&D(!0)},[x]);const O=e=>{_("file",e.target.files[0]??null)},z=e=>{e.preventDefault(),R.file&&(T(!0),j(!0),U(route("personal-reports.import"),{forceFormData:!0,onFinish:()=>{T(!1),B("file"),j(!1)}}))},E=(e,s)=>{if(s==="all")return!0;if(!e)return!1;const r=H(new Date),a=H(e),m=24*60*60*1e3,o=Math.floor((r-a)/m);switch(s){case"1w":return o>=0&&o<=7;case"2w":return o>7&&o<=14;case"3w":return o>14&&o<=21;case"1m":return o>21&&o<=31;case"gt1m":return o>31;default:return!0}},q=i.useMemo(()=>{const e=f.trim().toLowerCase();return(l??[]).filter(s=>{const r=I(s==null?void 0:s.opened_at),a=E(r,N),m=!e||String((s==null?void 0:s.ticket_number)??"").toLowerCase().includes(e)||String((s==null?void 0:s.client)??"").toLowerCase().includes(e)||String((s==null?void 0:s.unit)??"").toLowerCase().includes(e)||String((s==null?void 0:s.assignee)??"").toLowerCase().includes(e);return a&&m})},[l,f,N]),re=e=>{if(!e)return"";const s=I(e);return s?s.toLocaleString():""},ae=async()=>{j(!0);try{const e=await fetch(route("personal-reports.export-dashboard"));if(!e.ok){const m=await e.text();throw new Error(m||`HTTP ${e.status}`)}const s=await e.blob(),r=URL.createObjectURL(s),a=document.createElement("a");a.href=r,a.download=`dashboard_tickets_${new Date().toISOString()}.xlsx`,document.body.appendChild(a),a.click(),a.remove(),URL.revokeObjectURL(r)}catch(e){alert("Hubo un error al descargar el archivo"),console.error(e)}finally{j(!1)}},oe=[{field:"ticket_number",headerName:"Ticket",flex:.8,minWidth:120,renderCell:e=>{var s;return t.jsx(n,{children:((s=e.row)==null?void 0:s.ticket_number)??""})}},{field:"opened_at",headerName:"F. de alta",flex:1,minWidth:160,renderCell:e=>{var s;return t.jsx(n,{children:re((s=e.row)==null?void 0:s.opened_at)})}},{field:"count",headerName:"No. de registros",flex:.8,minWidth:120,renderCell:e=>{var s;return t.jsx(n,{children:((s=e.row)==null?void 0:s.count)??""})}},{field:"assignee",headerName:"Asignado",flex:1.2,minWidth:160,renderCell:e=>{var s;return t.jsx(n,{children:((s=e.row)==null?void 0:s.assignee)??""})}},{field:"client",headerName:"Cliente",flex:1,minWidth:140,renderCell:e=>{var s;return t.jsx(n,{children:((s=e.row)==null?void 0:s.client)??""})}},{field:"unit",headerName:"Unidad",flex:1,minWidth:140,renderCell:e=>{var s;return t.jsx(n,{children:((s=e.row)==null?void 0:s.unit)??""})}},{field:"contact",headerName:"Contacto",flex:1,minWidth:160,renderCell:e=>{var s;return t.jsx(n,{children:((s=e.row)==null?void 0:s.contact)??""})}},{field:"description",headerName:"Descripción",flex:1.6,minWidth:220,renderCell:e=>{var s,r;return t.jsx(n,{sx:{width:"100%",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",cursor:(s=e.row)!=null&&s.description?"zoom-in":"default"},title:"Doble clic para ver completo",children:((r=e.row)==null?void 0:r.description)??""})}}];return t.jsxs(de,{header:t.jsx("h2",{className:"text-xl font-semibold leading-tight text-gray-800",children:"Importar reporte de tickets"}),children:[t.jsx(le,{title:"Personal Reports"}),t.jsxs(n,{p:3,children:[t.jsxs(Q,{spacing:2,sx:{mb:2},children:[k&&t.jsx(V,{severity:"success",onClose:()=>D(!1),children:x}),L.file&&t.jsx(V,{severity:"error",children:L.file})]}),t.jsx(he,{open:b,sx:{color:"#fff",zIndex:e=>e.zIndex.modal+1},children:t.jsx(Z,{color:"inherit"})}),t.jsxs(ee,{sx:{mb:3},children:[t.jsx(se,{title:"Subir archivo Excel",subheader:"Formatos permitidos: .xlsx, .xls, .csv"}),t.jsx(te,{children:t.jsxs("form",{onSubmit:z,encType:"multipart/form-data",children:[t.jsxs(Q,{direction:{xs:"column",sm:"row"},spacing:2,alignItems:"center",children:[t.jsx("input",{type:"file",accept:".xlsx,.xls,.csv",onChange:O,disabled:c}),t.jsx(G,{type:"submit",variant:"contained",disabled:!R.file||c,children:c?"Importando...":"Importar"}),t.jsx(G,{variant:"outlined",onClick:ae,disabled:b,startIcon:b&&t.jsx(Z,{size:20}),children:b?"Descargando...":"Descargar dashboard Excel"})]}),(w||c)&&t.jsxs(n,{sx:{mt:2},children:[t.jsx(v,{variant:"caption",children:"Progreso"}),t.jsx(xe,{variant:"determinate",value:(w==null?void 0:w.percentage)??100})]})]})})]}),t.jsxs(ee,{children:[t.jsx(se,{title:"Últimos registros importados"}),t.jsxs(te,{children:[t.jsxs(n,{display:"flex",gap:2,mb:2,alignItems:"center",flexWrap:"wrap",children:[t.jsx(fe,{size:"small",label:"Buscar (ticket / cliente / unidad / asignado)",value:f,onChange:e=>A(e.target.value),sx:{minWidth:360}}),t.jsxs(ge,{size:"small",sx:{minWidth:240},children:[t.jsx(Ce,{id:"age-filter-label",children:"Creado"}),t.jsxs(be,{labelId:"age-filter-label",label:"Creado",value:N,onChange:e=>M(e.target.value),children:[t.jsx(S,{value:"all",children:"Todos"}),t.jsx(S,{value:"1w",children:"Creado hace 1 semana"}),t.jsx(S,{value:"2w",children:"Creado hace 2 semanas"}),t.jsx(S,{value:"3w",children:"Creado hace 3 semanas"}),t.jsx(S,{value:"1m",children:"Creado hace 1 mes"}),t.jsx(S,{value:"gt1m",children:"Creado hace más de 1 mes"})]})]})]}),t.jsx(ve,{rows:q,columns:oe,getRowId:e=>(e==null?void 0:e.id)??`${e.ticket_number}-${e.opened_at}-${Math.random()}`,pageSize:10,rowsPerPageOptions:[5,10,20],disableSelectionOnClick:!0,autoHeight:!0,onCellDoubleClick:C})]}),t.jsxs(je,{open:W,onClose:()=>P(!1),maxWidth:"md",fullWidth:!0,children:[t.jsx(we,{children:u}),t.jsx(ye,{dividers:!0,children:t.jsx(v,{sx:{whiteSpace:"pre-wrap"},children:h})}),t.jsx(Se,{children:t.jsx(G,{onClick:()=>P(!1),variant:"contained",children:"Cerrar"})})]})]})]})]})}export{nt as default};
