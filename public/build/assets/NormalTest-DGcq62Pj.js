import{r as i,j as s,a as ue}from"./app-CH96BYvV.js";import{d as de}from"./index-CBXjXr8o.js";import{D as me}from"./Dialog-DaHBrYrL.js";import{D as fe,a as xe,b as pe}from"./DialogTitle-BUfX-gUw.js";import{a as ge,g as he,b as _e,s as Ce,k as we,d as be,T as h,v as je,u as Se,r as Re,ag as Te}from"./Modal-DvEijvXY.js";import{B as S}from"./Button-DWfk6Uyo.js";import{S as ke}from"./Slide-CYZc4SnH.js";import{T as ve}from"./TestResultDialog-CwJG2XXT.js";import{u as B}from"./index-BdiXYr2f.js";import{C as ye}from"./Card-DsoVOp38.js";import{C as De}from"./CardContent-Dwu__uFX.js";import{L as G}from"./LinearProgress-DsgIXECl.js";import{B as j}from"./Box-DfhpD6Xd.js";import{R as Ie,a as Ae}from"./RadioGroup-Jj_6BOlK.js";import{F as Fe,S as Oe}from"./Stack-DBHzZPeh.js";import"./getThemeProps-wpIVBAsW.js";import"./index-DAAXfJ6R.js";import"./createSvgIcon-oRuVzhHR.js";import"./useFormControl-5PtIKLkw.js";import"./FormGroup-AM0v8vyl.js";import"./useThemeProps-DKFKiMUH.js";function Le(o){return ge("MuiDialogContentText",o)}he("MuiDialogContentText",["root"]);const Ee=o=>{const{classes:l}=o,m=be({root:["root"]},Le,l);return{...l,...m}},Ne=Ce(h,{shouldForwardProp:o=>je(o)||o==="classes",name:"MuiDialogContentText",slot:"Root"})({}),Me=i.forwardRef(function(l,d){const m=_e({props:l,name:"MuiDialogContentText"}),{children:g,className:R,...a}=m,c=Ee(a);return s.jsx(Ne,{component:"p",variant:"body1",color:"textSecondary",ref:d,ownerState:a,className:we(c.root,R),...m,classes:c})}),Pe=i.forwardRef(function(l,d){return s.jsx(ke,{direction:"up",ref:d,...l})});function Ue({open:o,close:l,message:d,image:m}){return s.jsx(i.Fragment,{children:s.jsxs(me,{open:o,slots:{transition:Pe},keepMounted:!0,onClose:l,"aria-describedby":"alert-dialog-slide-description",PaperProps:{sx:{borderRadius:4}},children:[s.jsx(fe,{children:"Explicación"}),s.jsx(xe,{children:s.jsxs(Me,{id:"alert-dialog-slide-description",children:[d,m&&s.jsx("div",{style:{display:"flex",justifyContent:"center",margin:"20px 0"},children:s.jsx("img",{src:m,alt:"feedback image",style:{height:300,width:"auto"}})})]})}),s.jsx(pe,{children:s.jsx(S,{onClick:l,children:"Cerrar"})})]})})}function lt({test:o,subject:l,type:d}){const m=Se(),g=B(m.breakpoints.up("md")),R=B(m.breakpoints.down("sm")),[a,c]=i.useState(0),[_,T]=i.useState({}),t=o.test_questions[a],[C,k]=i.useState(null),[H,v]=i.useState(null),[y,D]=i.useState(!1),[b,E]=i.useState(!1),[W,I]=i.useState(null),[N,M]=i.useState(null),[Z,P]=i.useState(!1),A=i.useRef(new Set),U=i.useRef(new Set),[X,$]=i.useState(!1),[q,z]=i.useState({correct:0,total:0}),J=String((t==null?void 0:t.correct_answer)||"").toUpperCase(),w=e=>(e==null?void 0:e.is_correct)!==null||!!(e!=null&&e.user_answer),K=e=>{const r={};return e.forEach(n=>{n.user_answer&&(r[n.id]=String(n.user_answer).toLowerCase())}),r},V=e=>{const r=e.findIndex(n=>!w(n));return r===-1?0:r},F=(e,r)=>{for(let n=r+1;n<e.length;n++)if(!w(e[n]))return n;return null},f=t?w(t)||U.current.has(t.id):!1;i.useEffect(()=>{var e;(e=o==null?void 0:o.test_questions)!=null&&e.length&&(T(K(o.test_questions)),c(V(o.test_questions)))},[o==null?void 0:o.id]),i.useEffect(()=>{if(!y||b)return;const e=setTimeout(()=>{oe()},2500);return()=>clearTimeout(e)},[y,b]),i.useEffect(()=>{if(!t)return;if(w(t)){I(null),M(null);return}const e=(t==null?void 0:t.limit_time)??null;if(I(e),M(e),!e)return;const r=setInterval(()=>{I(n=>n===null?n:n<=1?(clearInterval(r),O(null,!0),0):n-1)},1e3);return()=>clearInterval(r)},[t]);const Y=e=>{f||T(r=>({...r,[t.id]:e.target.value.toLowerCase()}))},O=(e="",r=!1)=>{if(f)return;const n=(e||"").toLowerCase(),x=n.toUpperCase(),u=!r&&x===t.correct_answer;U.current.add(t.id),T(p=>({...p,[t.id]:r?"__timeout__":n})),r||(k(u?"correct":"incorrect"),u||v(t.correct_answer),!u&&(t.feedback_text||t.feedback_image)&&(E(!0),P(!0)),D(!0)),Q({test_id:o==null?void 0:o.id,subject_id:(l==null?void 0:l.id)??null,current_question:t,is_correct:r?0:u?1:0,user_answer:r?null:x}),setTimeout(()=>D(!1),5e3)},Q=async e=>{var p;const r=`${e.test_id}:${(p=e.current_question)==null?void 0:p.question_id}`;if(A.current.has(r))return;A.current.add(r);const n=new AbortController,x=setTimeout(()=>n.abort("timeout"),4e3);try{await ue.post(route("answer.save"),e,{signal:n.signal,headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json"}})}catch(L){L.message==="timeout"||L.code==="ERR_CANCELED"?console.warn("⏳ La petición se canceló por timeout (4s)."):console.error("❌ Error al enviar respuesta",L),A.current.delete(r)}finally{clearTimeout(x)}const u=F(o.test_questions,a);u!==null?c(u):a<o.test_questions.length-1&&c(a+1)},ee=()=>{if(f){const r=F(o.test_questions,a);r!==null?c(r):a<o.test_questions.length-1&&c(a+1);return}const e=_[t.id];e&&e!=="__timeout__"&&(O(e),setTimeout(()=>{k(null),v(null)},3e3))},te=()=>{a>0&&c(a-1)},se=()=>{const e=_[t.id];e&&e!=="__timeout__"&&O(e);const r=le();z(r),$(!0)},re=o.test_questions.filter(e=>w(e)).length/o.test_questions.length*100,oe=()=>{const e=F(o.test_questions,a);e!==null?c(e):a<o.test_questions.length-1&&c(a+1),k(null),v(null),D(!1)},ne=()=>{E(!1),P(!1)},ie=e=>{if(typeof e!="string")return!1;const r=e.trim();return!!(/^data:image\//i.test(r)||/^https?:\/\/.+\.(png|jpe?g|gif|svg|webp)(\?.*)?$/i.test(r)||/^[\w.\-\/]+?\.(png|jpe?g|gif|svg|webp)$/i.test(r))},ae=(_[t.id]==="__timeout__"?"":_[t.id]||(t==null?void 0:t.user_answer)||"").toString().toLowerCase(),le=()=>{const e=o.test_questions.length;return{correct:o.test_questions.reduce((n,x)=>{const u=_[x.id],p=u&&u!=="__timeout__"?u.toUpperCase():x.user_answer||null;return p?n+(p===x.correct_answer?1:0):n},0),total:e}},ce=()=>{de.Inertia.get(route("student.subject.index"))};return s.jsxs(s.Fragment,{children:[s.jsx(ye,{sx:{mb:g?2:1,mt:g?2:1,mx:g?"auto":1,width:g?"60%":"100%",borderRadius:3,boxShadow:3,backgroundColor:"rgba(255,255,255,0.95)",border:"1px solid #e0e0e0"},children:s.jsxs(De,{sx:{backgroundColor:`${l.color}80`,borderTopLeftRadius:"12px",borderTopRightRadius:"12px"},children:[s.jsx(h,{variant:"h6",gutterBottom:!0,children:l.name}),s.jsx(G,{variant:"determinate",value:re})]})}),s.jsx(j,{sx:{mt:4,mb:2,px:1,display:"flex",alignItems:"flex-start",justifyContent:"center",minHeight:"calc(100vh - 220px)"},children:s.jsxs(Re,{elevation:3,sx:{width:"100%",maxWidth:g?600:"95%",p:3,borderRadius:3,boxShadow:3,backgroundColor:"rgba(255,255,255,0.95)",border:"1px solid #e0e0e0"},children:[N&&s.jsx(G,{variant:"determinate",value:W/N*100,sx:{mt:2,height:10,borderRadius:5}}),s.jsxs(h,{variant:"subtitle1",gutterBottom:!0,children:["Pregunta ",a+1," de ",o.test_questions.length]}),(t==null?void 0:t.type)==="image"?s.jsx(j,{component:"img",src:`${t.question_text}`,alt:"Pregunta",sx:{width:"100%",maxWidth:350,maxHeight:350,height:"auto",display:"block",mx:"auto",mb:4}}):s.jsx(h,{variant:"h6",sx:{marginBottom:"20px"},gutterBottom:!0,children:t.question_text}),s.jsx(Ie,{value:ae,onChange:f?void 0:Y,children:Object.entries(JSON.parse(t.options)).filter(([e,r])=>r!=null&&r!=="").map(([e,r])=>{const n=String(r).trim();return s.jsx(Fe,{value:e,control:s.jsx(Ae,{disabled:f}),disabled:f,sx:{mb:2,marginTop:"15px",...f?{opacity:.8}:{}},label:ie(n)?s.jsx(j,{component:"img",src:n,alt:`Opción ${e.toUpperCase()}`,sx:{width:70,height:70,objectFit:"contain",border:"1px solid #ccc",p:1}}):`${e.toUpperCase()}: ${n}`},e)})}),s.jsxs(Oe,{direction:"row",justifyContent:"space-between",mt:3,children:[s.jsx(S,{variant:"outlined",onClick:te,disabled:a===0,children:"Anterior"}),a<o.test_questions.length-1?s.jsx(S,{variant:"contained",onClick:ee,children:"Siguiente"}):s.jsx(S,{variant:"contained",color:"success",onClick:se,children:"Finalizar"})]}),C||d!=="RAZONAMIENTO LOGICO"?s.jsx(Te,{in:y,timeout:{enter:300,exit:1e3},onExited:()=>{},children:s.jsxs(j,{sx:{mt:2,p:2,borderRadius:2,backgroundColor:C==="correct"?"#dcfce7":"#fee2e2",color:C==="correct"?"#15803d":"#b91c1c",display:"flex",alignItems:"center",gap:2},children:[s.jsx("img",{src:C==="correct"?"/assets/correct.gif":"/assets/incorrect.gif",alt:"feedback gif",style:{height:70}}),s.jsx(h,{variant:"h6",children:C==="correct"?"¡Muy bien! Respuesta correcta.":`Incorrecto. La respuesta correcta era: ${H}`})]})}):null,f&&d!=="RAZONAMIENTO LOGICO"?s.jsxs(h,{variant:"h5",sx:{mb:2},children:["Correcta: ",s.jsx("strong",{children:J})]}):null]})}),s.jsx(Ue,{open:b,close:ne,message:t==null?void 0:t.feedback_text,image:t==null?void 0:t.feedback_image}),s.jsx(ve,{open:X,onClose:()=>$(!1),correct:q.correct,total:q.total,onGoToSubjects:ce,showReview:d!=="RAZONAMIENTO LOGICO"})]})}export{lt as default};
