import{r as n,j as t,a as me}from"./app-DR2zBp-L.js";import{d as pe}from"./index-Dec7CTD8.js";import he from"./CatchGame-BU58RhcQ.js";import xe from"./PlanePathGame-DBYG1Ci3.js";import{T as ge}from"./TestResultDialog-f3uQm_MS.js";import{C as we}from"./Card-BM8VDuao.js";import{C as Ce}from"./CardContent-DBnTqczx.js";import{T as C,r as N}from"./Modal-CRrWWUgi.js";import{L as je}from"./LinearProgress-DTq8upgn.js";import{B as Se}from"./Box-B9u98YDw.js";import{S as J,F as X}from"./Stack-B441S073.js";import{B as D}from"./Button-OQKuQoda.js";import{D as be}from"./Dialog-D3QxleVS.js";import{D as Re,a as ve,b as ye}from"./DialogTitle-C9EyRGxo.js";import{R as _e,a as K}from"./RadioGroup-JzkvrP64.js";import"./Slide-D9XNXjGy.js";import"./index-BDNgXLEW.js";import"./useFormControl-CuErMVQB.js";import"./useThemeProps-CDjvlXDC.js";import"./getThemeProps-Sn2k6trT.js";import"./createSvgIcon-CZbv8gad.js";import"./FormGroup-CMzGgGGA.js";function Ke({test:a,subject:u}){var U,$;const d=(a==null?void 0:a.test_questions)||[],j=n.useMemo(()=>d.filter(e=>e.type==="math"),[d]),S=n.useMemo(()=>d.filter(e=>e.type==="figure"),[d]),i=n.useMemo(()=>{const e=[],r=Math.min(j.length,S.length);for(let o=0;o<r;o++)e.push([j[o],S[o]]);return e},[j,S]),b=n.useRef({});n.useEffect(()=>{const e={};for(const r of d)e[r.id]=(r==null?void 0:r.is_correct)!==null||(r==null?void 0:r.user_answer)!==null&&(r==null?void 0:r.user_answer)!=="";b.current=e},[d]);const[p,v]=n.useState(0),[Y,Z]=n.useState({}),[F,V]=n.useState({}),[f,q]=n.useState({}),[E,ee]=n.useState({}),[m,y]=n.useState(null),[re,_]=n.useState(!0),I=e=>`mtk:gameType:${e}`,[te,G]=n.useState(0),[ne,L]=n.useState(!1),[W,oe]=n.useState({correct:0,total:100}),z=e=>(e==null?void 0:e.is_correct)!==null||(e==null?void 0:e.user_answer)!==null&&(e==null?void 0:e.user_answer)!=="",B=e=>z(e)||!!f[e==null?void 0:e.id],k=(e,r)=>{const[o,s]=i[e]||[],c=l=>!l||z(l)||!!r[l.id];return c(o)&&c(s)},O=e=>{if(!i.length)return!1;for(let r=0;r<i.length;r++)if(!k(r,e))return!1;return!0};function se(e){for(let r=0;r<e.length;r++){const[o,s]=e[r],c=b.current[o.id]||f[o.id],l=b.current[s.id]||f[s.id];if(!c||!l)return r}return e.length?0:null}function M(e){return k(e,f)}function ie(){for(let e=p+1;e<i.length;e++)if(!M(e)){v(e);return}for(let e=0;e<i.length;e++)if(!M(e)){v(e);return}A()}n.useEffect(()=>{const e=se(i);e!==null&&v(e)},[i.length]),n.useEffect(()=>{if(!(a!=null&&a.id))return;const e=localStorage.getItem(I(a.id));e==="vertical"||e==="horizontal"?(y(e),_(!1)):(y(null),_(!0))},[a==null?void 0:a.id]);const ae=()=>{m&&(localStorage.setItem(I(a.id),m),_(!1))},T=n.useRef(new Set),ce=e=>{var c;const r=`${e.test_id}:${(c=e.current_question)==null?void 0:c.id}`;if(T.current.has(r))return Promise.resolve();T.current.add(r);const o=new AbortController,s=setTimeout(()=>o.abort("timeout"),4e3);return me.post(route("answer.save"),e,{signal:o.signal,headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json"}}).catch(l=>{console.error("❌ Error al enviar respuesta",l),T.current.delete(r)}).finally(()=>clearTimeout(s))},R=n.useRef(!1),H=(e,r)=>{if(!e||B(e))return;const o=String(r).toUpperCase()===String(e.correct_answer).toUpperCase();Z(s=>({...s,[e.id]:r})),V(s=>({...s,[e.id]:o?"correct":"incorrect"})),q(s=>{const c={...s,[e.id]:!0};ee(g=>({...g,[e.id]:o?1:0}));const l={test_id:a==null?void 0:a.id,subject_id:(u==null?void 0:u.id)??null,current_question:e,is_correct:o?1:0,user_answer:String(r)};return ce(l).then(()=>{b.current[e.id]=!0}),k(p,c)&&(O(c)?R.current||(R.current=!0,A()):ie()),c})};n.useEffect(()=>{!R.current&&O(f)&&(R.current=!0,A())},[f,i]);const le=n.useMemo(()=>{let e=0;for(let r=0;r<i.length;r++)M(r)&&(e+=1);return e},[p,f,d]),ue=i.length?le/i.length*100:0;function A(){const e=i.length||1,r=j.reduce((g,w)=>{const P=w.is_correct===1||E[w.id]===1?1:0;return g+P},0),o=S.reduce((g,w)=>{const P=w.is_correct===1||E[w.id]===1?1:0;return g+P},0),s=Math.round(r/e*100),c=Math.round(o/e*100),l=Math.round(.4*(te||0)+.3*s+.3*c);oe({correct:l,total:100}),L(!0)}const h=(U=i[p])==null?void 0:U[0],x=($=i[p])==null?void 0:$[1],de=e=>F[e]==="correct",fe=e=>F[e]==="incorrect",Q=(e,r)=>{const o=Y[e.id],s={minWidth:120,backgroundColor:"#e0e0e0",color:"#000",border:"2px solid transparent"};if(B(e))return{...s,opacity:.7,pointerEvents:"none"};if(o===r){if(de(e.id))return{...s,backgroundColor:"#dcfce7",border:"2px solid #16a34a"};if(fe(e.id))return{...s,backgroundColor:"#fee2e2",border:"2px solid #dc2626"}}return s};return t.jsxs(t.Fragment,{children:[t.jsx(we,{sx:{mb:4,borderRadius:3,boxShadow:3},children:t.jsxs(Ce,{sx:{backgroundColor:`${(u==null?void 0:u.color)??"#1976d2"}80`,borderTopLeftRadius:"12px",borderTopRightRadius:"12px"},children:[t.jsx(C,{variant:"h6",children:(u==null?void 0:u.name)??"Multitasking"}),t.jsx(je,{variant:"determinate",value:ue})]})}),t.jsxs(Se,{display:"flex",justifyContent:"center",alignItems:"stretch",gap:2,flexWrap:"wrap",px:2,minHeight:"60vh",children:[t.jsxs(N,{sx:{p:3,width:500,borderRadius:3,backgroundColor:"#fff",display:"flex",flexDirection:"column",alignItems:"center",minHeight:420},children:[m==="vertical"&&t.jsx(he,{onFinish:e=>G(e??0)}),m==="horizontal"&&t.jsx(xe,{onFinish:e=>G(e??0)}),!m&&t.jsx(C,{variant:"body2",color:"text.secondary",sx:{mt:2},children:"Selecciona un juego para comenzar."})]}),t.jsxs(N,{sx:{p:3,width:500,borderRadius:3,backgroundColor:"#fff",display:"flex",flexDirection:"column",alignItems:"center"},children:[h&&t.jsxs(t.Fragment,{children:[t.jsx(C,{variant:"h3",mb:2,textAlign:"center",sx:{mt:2},children:h.question_text}),t.jsx(J,{direction:"row",spacing:2,mb:5,flexWrap:"wrap",justifyContent:"center",children:Object.entries(JSON.parse(h.options||"{}")).filter(([e,r])=>r!=null&&r!=="").slice(0,2).map(([e,r])=>t.jsx(D,{variant:"contained",sx:Q(h,r),onClick:()=>H(h,r),children:r},e))})]}),x&&t.jsxs(t.Fragment,{children:[t.jsx(C,{variant:"h2",mb:2,textAlign:"center",sx:{color:"#203764"},children:x.question_text}),t.jsx(J,{direction:"row",spacing:2,mb:2,flexWrap:"wrap",justifyContent:"center",children:Object.entries(JSON.parse(x.options||"{}")).filter(([e,r])=>r!=null&&r!=="").map(([e,r])=>t.jsx(D,{variant:"contained",sx:Q(x,r),onClick:()=>H(x,r),children:r},e))})]}),t.jsxs(C,{variant:"body2",color:"text.secondary",sx:{mt:1},children:["Bloque ",p+1," de ",i.length]})]})]}),t.jsxs(be,{open:re,children:[t.jsx(Re,{children:"¿Qué tipo de juego prefieres?"}),t.jsx(ve,{children:t.jsxs(_e,{value:m,onChange:e=>y(e.target.value),children:[t.jsx(X,{value:"vertical",control:t.jsx(K,{}),label:"Vertical (Balde)"}),t.jsx(X,{value:"horizontal",control:t.jsx(K,{}),label:"Horizontal (Avión)"})]})}),t.jsx(ye,{children:t.jsx(D,{onClick:ae,disabled:!m,variant:"contained",children:"Comenzar"})})]}),t.jsx(ge,{open:ne,onClose:()=>L(!1),correct:W.correct,total:W.total,onGoToSubjects:()=>pe.Inertia.get(route("student.subject.index")),showReview:!1})]})}export{Ke as default};
